---
title: "Visualizing, Modeling and Forecasting Crashes in Wake County, North Carolina"
author: "Cortlyn Morris, Kelly Wentzlof, Ayan Gulzar"
date: "6/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Here we will be loading necessary packages.

```{r, message=FALSE, warning=FALSE}
library(reshape2)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(dslabs)
library(ggrepel)
library(ggthemes)
library(maps)
library(scales)
```

### Setting working directory.

```{r}
#setwd("/Users/cmorris/Desktop/dsreu2021/rstudiodirectory/ResearchProject")
```

### Reading and merging the data.

```{r}
#Code for Cortlyn's computer (Mac)
# persons <- read.csv(file="Persons_Involved_in_Crashes.csv")
# glimpse(persons)
# 
# locations <- read.csv(file="Reported_Crash_Locations.csv")
# glimpse(locations)
# 
# crashes <- persons %>% left_join(locations, by="key_crash")

#Code for Kelly's computer (Windows)
library(readr)
persons <- read_csv("~/NCAT REU/Mostafa/Data/Persons_Involved_in_Crashes.csv")

locations <- read_csv("~/NCAT REU/Mostafa/Data/Reported_Crash_Locations.csv")
glimpse(locations)

crashes <- persons %>% left_join(locations, by="key_crash")
```

## Exploratory data analysis 

### Frequency of crashes by vehicle type

The highest frequency of crashes occur in a passenger car. However, this is not very surprising because passenger cars are relatively common. An interesting note is that sport utility vehicles have the second highest frequency of crashes, however, sport utility vehicles are not nearly as common of a car.

```{r}
crashes %>% 
  filter(VehicleType != "Unknown", VehicleType != "") %>%
  count(VehicleType) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         VehicleType = reorder(VehicleType,logtrans)) %>% 
  ggplot(aes(x=VehicleType, y=logtrans, fill=VehicleType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) + 
  labs(title = "Frequency of Crashes by Vehicle Type", 
       x = "Vehicle Type", 
       y = "Count (log10 Scale)")
```

### Frequency of crashes by weather condition.

The highest frequency of crashes occur when the weather conditions are clear. This is not very surprising because in North Carolina, the majority of the time the weather is clear. An interesting note is that snow still has a relatively high frequency despite it snowing minimally in North Carolina. 

```{r}
crashes %>% 
  filter(WeatherCondition1 != "NA") %>%
  count(WeatherCondition1) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         WeatherCondition1 = reorder(WeatherCondition1,logtrans)) %>% 
  ggplot(aes(x=WeatherCondition1, y=logtrans, fill=WeatherCondition1)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Weather Condition",
       x = "Weather Condition",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Weather Condition and if Weather Contributed to Crash

```{r}
crashes %>% 
  filter(WeatherCondition1 != "NA", WeatherContributedToCrash == "Yes") %>%
  count(WeatherCondition1) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         WeatherCondition1 = reorder(WeatherCondition1,logtrans)) %>% 
  ggplot(aes(x=WeatherCondition1, y=logtrans, fill=WeatherCondition1)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = 
  "Frequency of Crashes by Weather Condition and if Weather Contributed to Crash",
       x = "Weather Condition",
       y = "Count (log10 Scale)")
```

### Frequency of crashes by traffic control type.

The highest frequency of crashes occur when there is no traffic control present. Without a control present, drivers may be less confident in their actions. 

```{r}
crashes %>% 
  filter(TrafficControlType != "NA", TrafficControlType != "", 
         TrafficControlType != "NaN") %>%
  count(TrafficControlType) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         TrafficControlType = reorder(TrafficControlType,logtrans)) %>% 
  ggplot(aes(x=TrafficControlType, y=logtrans, fill=TrafficControlType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Traffic Control Type",
       x = "Traffic Control Type",
       y = "Count (log10 Scale)")
```
 
### Frequency of crashes by road feature.

The highest frequency of crashes occur when there is no special road feature present. Without a road feature present, drivers may be less confident in their actions. 

```{r}
crashes %>% 
  filter(RoadFeature != "NA", RoadFeature != "", RoadFeature != "NaN") %>%
  count(RoadFeature) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         RoadFeature = reorder(RoadFeature,logtrans)) %>% 
  ggplot(aes(x=RoadFeature, y=logtrans, fill=RoadFeature)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Road Feature",
       x = "Road Feature",
       y = "Count (log10 Sclae)")
```

### Histogram for Drivers' Ages 

```{r}
crashes %>%
  filter(PersonType == "Driver", Age != "NA", Age != "NaN", Age != "") %>%
  ggplot() +
  geom_histogram(aes(x=Age), binwidth = 5, col="red", fill="darkgrey") +
  labs(title="Histogram for Drivers' Ages", x="Age", y="Frequency")
```

### Frequency of Crashes by Alcohol Result Type (including Unknown and Pending results)

```{r}
crashes %>% 
  filter(AlcoholResultType != "NA", AlcoholResultType != "", 
         AlcoholResultType != "NaN", AlcoholResultType != "Contaminated sample/unusable") %>%
  count(AlcoholResultType) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         AlcoholResultType = reorder(AlcoholResultType,logtrans)) %>% 
  ggplot(aes(x=AlcoholResultType, y=logtrans, fill=AlcoholResultType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Alcohol Result Type",
       x = "Alcohol Result Type",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Alcohol Result Type and Crash Date DOW 

```{r}
crashes %>%
  filter(AlcoholResultType != "NA", AlcoholResultType != "Unknown", 
         Crash_Date_DOW != "NA", Crash_Date_DOW != "NaN", Crash_Date_DOW != "") %>%
  group_by(AlcoholResultType) %>%
  ggplot(aes(fill=AlcoholResultType, x=Crash_Date_DOW)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Alcohol Result Type Frequency by Crash Date DOW",
       x = "Crash Date DOW",
       y = "Percentage")
```

### Frequency of Crashes by Alcohol Result Type (excluding Unknown and Pending results)

```{r}
crashes %>% 
  filter(AlcoholResultType != "NA", AlcoholResultType != "", 
         AlcoholResultType != "NaN", AlcoholResultType != 
           "Contaminated sample/unusable", AlcoholResultType != "Pending",
         AlcoholResultType != "Unknown") %>%
  count(AlcoholResultType) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         AlcoholResultType = reorder(AlcoholResultType,logtrans)) %>% 
  ggplot(aes(x=AlcoholResultType, y=logtrans, fill=AlcoholResultType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Alcohol Result Type",
       x = "Alcohol Result Type",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Day of Week

```{r}
crashes %>% 
  filter(Crash_Date_DOW != "NA") %>%
  mutate(Crash_Date_DOW = factor(Crash_Date_DOW, levels = c("Sunday","Monday", "Tuesday", "Wednesday", 
                                   "Thursday", "Friday", "Saturday"))) %>%
  ggplot() +
  geom_bar(aes(Crash_Date_DOW, fill=Crash_Date_DOW), show.legend = FALSE) +
  geom_text(stat="count", aes(x=Crash_Date_DOW, label=..count..), vjust=-0.25) +
  labs(title = "Frequency of Crashes by Day of Week",
       x = "Day of Week",
       y = "Count")
```

### Frequency of Crashes by Month

```{r}
crashes %>% 
  filter(Crash_Date_Month != "NA") %>%
  mutate(Crash_Date_Month = factor(Crash_Date_Month, 
                                   levels = c("January","February",
                                              "March", "April",
                                              "May", "June", "July",
                                              "August", "September",
                                              "October", "November",
                                              "December"))) %>%
  ggplot() +
  geom_bar(aes(Crash_Date_Month, fill=Crash_Date_Month), show.legend = FALSE) +
  geom_text(stat="count", aes(x=Crash_Date_Month, label=..count..), vjust=-0.25) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Frequency of Crashes by Month",
       x = "Month",
       y = "Count")
```

### Frequency of Crashes by Hour

```{r}
crashes %>%
  filter(Crash_Date_Hour != "NA", Crash_Date_Hour != "") %>%
  ggplot() +
  geom_bar(aes(Crash_Date_Hour)) +
  labs(title="Frequency of Crashes by Hour", x="Hour", y="Count")
```

### Frequency of Crashes by Shift

```{r}
crashes %>%
  filter(Crash_Date_Hour != "NA", Crash_Date_Hour != "") %>%
  mutate(shift = ifelse(
    Crash_Date_Hour >= 6 & Crash_Date_Hour < 14, "Shift 1", 
    ifelse(Crash_Date_Hour >= 14 & Crash_Date_Hour < 22, "Shift 2", "Shift 3"))) %>%
  ggplot() +
  geom_bar(aes(x=shift, fill = shift)) +
  labs(title="Frequency of Crashes by Shift", x="Shift", y="Count")
```


### Frequency of Crashes by Drivers' v. Passengers' Age

The range of drivers' ages is from about 16 to 100. The range of passengers' ages is from about 0 to 100. The range of drivers' ages is slightly larger due to the age restrictions for getting a license. 

```{r}
crashes %>% 
  filter(PersonType == "Driver" | PersonType == "Passenger", Age != "", Age != "NA") %>% 
  ggplot() +
  geom_histogram(aes(x=Age), binwidth = 5, col="red", fill="darkgrey") +
  labs(x="Age", y="Frequency", title="Drivers' vs. Passengers' Age") +
  theme(legend.position = "top") +
  facet_wrap(~PersonType, dir = "v")
```

### Frequency of Crashes by Drivers' v. Passengers' Gender

There are slighlty more male drivers in Wake County getting in crashes than female drivers. Additionally, there are slightly more female passengers in Wake County car crashes than male passengers. 

```{r}
crashes %>% 
  filter(PersonType == "Driver" | PersonType == "Passenger", 
         Gender != "NA", Gender != "Unknown") %>% 
  ggplot() +
  geom_bar(aes(x=Gender), col="red", fill="darkgrey") +
  labs(x="Gender", y="Frequency", title="Drivers' vs. Passengers' Gender") +
  theme(legend.position = "top") +
  facet_wrap(~PersonType)
```

### Frequency of Crashes by Vehicle Seizure

About half as many vehicles were seized compared to vehicles not seized. 

```{r} 
crashes %>% 
  filter(VehicleSeizure != "NA") %>%
  count(VehicleSeizure) %>% 
  mutate(logtrans = round(log10(n), digits = 2)) %>% 
  ggplot(aes(x=VehicleSeizure, y=logtrans, fill=VehicleSeizure)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  labs(title = "Frequency of Crashes by Vehicle Seizure",
       x = "Vehicle Seizure",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Airbag Deployed

The highest frequency of crashes occured where the airbags were not deployed. It is interesting to note that the second highest frequency of crashes occured where the car(s) did not have airbags to begin with. 
Airbags did not deploy during most crashes, therefore many accidents logged were minor. 

```{r}
crashes %>% 
  filter(AirbagDeployed != "NA", AirbagDeployed != "Unknown") %>%
  count(AirbagDeployed) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         AirbagDeployed = reorder(AirbagDeployed,logtrans)) %>% 
  ggplot(aes(x=AirbagDeployed, y=logtrans, fill=AirbagDeployed)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Airbag Deployed",
       x = "Airbag Deployed",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Ejection

Most car crashes resulted in drivers and passengers not being ejected. More people were totally ejected from the vehicle than partially ejected. 

```{r}
crashes %>% 
  filter(Ejection != "NA", Ejection != "Unknown") %>%
  count(Ejection) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         Ejection = reorder(Ejection,logtrans)) %>% 
  ggplot(aes(x=Ejection, y=logtrans, fill=Ejection)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Ejection",
       x = "Ejection",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Gender 

About 3 more percent of people that get in crashes are men than women. 

```{r}
crashes %>% 
  filter(Gender != "NA", Gender != "Unknown", Gender != "") %>%
  count(Gender) %>% 
  mutate(Percent = round(n/sum(n)*100,2), 
         Gender = reorder(Gender,Percent)) %>% 
  ggplot(aes(x=Gender, y=Percent, fill=Gender)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label= Percent),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Gender",
       x = "Gender",
       y = "Percent")
```

### Frequency of Crashes by Race
According to census.gov...

In the United States, 76.3 % of people are White, 13.4% of people are Black or African American, 18.5% are Hispanic or Latina, 0.2 are Native Hawaiian and Other Pacific Islander, 2.8% are two or more races, 5.9% are Asian, 1.3% are American Indian and Alaska Native, . 

In North Carolina, 70.6 % of people are White, 22.2% of people are Black or African American, 9.8% are Hispanic or Latina, 0.1 are Native Hawaiian and Other Pacific Islander, 2.3% are two or more races, 3.2% are Asian, and 1.6% are American Indian and Alaska Native.

In Wake County, North Carolina, 67.9 % of people are White, 21.0% of people are Black or African American, 10.4% are Hispanic or Latina, 0.1% are Native Hawaiian and Other Pacific Islander, 2.6% are two or more races, 7.7% are Asian, and 0.8% are American Indian and Alaska Native.

This is interesting because, despite the percentage of Black people being less than a third of the percentage of White people, the percentage of Black people in car crashes is not far behind the percentage of White people in car crashes. 

```{r}
crashes %>% 
  filter(Race != "NA", Race != "Unknown", Race != "") %>%
  count(Race) %>% 
  mutate(Percent = round(n/sum(n)*100,2), 
         Race = reorder(Race,Percent)) %>% 
  ggplot(aes(x=Race, y=Percent, fill=Race)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Percent), nudge_y = 0.05) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Race",
       x = "Race",
       y = "Percent")
```

### Frequency of Crashes by Injury

The highest frequency of crashes did not result in any injury. Following the highest frequency, the more serious the injury, the less crashes occured. 

```{r}
crashes %>% 
  filter(Injury != "NA", Injury != "Unknown") %>%
  count(Injury) %>% 
  mutate(Percent = round(n/sum(n)*100, digits = 2), 
         Injury = reorder(Injury,Percent)) %>% 
  ggplot(aes(x=Injury, y=Percent, fill=Injury)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Percent),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Injury",
       x = "Injury",
       y = "Percent")
```

### Frequency of Injuries by Person Type (old code)

```{r}
# Finding the counts of each injury by person type
crashes %>% 
  filter(Injury != "NA", Injury != "Unknown", Injury != "", 
         PersonType == "Driver") %>%
  count(Injury)

crashes %>% 
  filter(Injury != "NA", Injury != "Unknown", Injury != "", 
         PersonType == "Passenger") %>%
  count(Injury)

crashes %>% 
  filter(Injury != "NA", Injury != "Unknown", Injury != "", 
         PersonType == "Pedestrian") %>%
  count(Injury)

crashes %>% 
  filter(Injury != "NA", Injury != "Unknown", Injury != "", 
         PersonType == "Pedalcyclist") %>%
  count(Injury)

crashes %>% 
  filter(Injury != "NA", Injury != "Unknown", Injury != "", 
         PersonType == "Other*") %>%
  count(Injury)

#Creating a dataset using injury type, person type, and counts
persontype2 <- c(rep("Driver" , 5) , rep("Passenger" , 5) , rep("Pedestrian" , 5) ,
                 rep("Pedalcyclist" , 5) , rep("Other" , 5) )

injury2 <- rep(c("Type A" , "Type B" , "Type C", "Killed", "No Injury") , 5)

value <- c(851, 7295, 22020, 105, 227811, 232, 2307, 9163, 31, 72373, 183, 596, 554,
           62, 154, 19, 168, 123, 3, 68, 10, 48, 34, 1, 141)

data <- data.frame(persontype2,injury2,value)
```

```{r}
#Bar plot
data %>%
  mutate(
         injury2 = reorder(injury2, -value),
         persontype2 = factor(persontype2,
                              levels = c("Driver", "Passenger", "Pedestrian", 
                                         "Pedalcyclist", "Other"))) %>%
  ggplot(aes(fill=injury2, y=value, x=persontype2)) +
  geom_bar(position="dodge", stat="identity") +
  geom_text(aes(label=value), nudge_x = -0.35) +
  coord_flip()
```

### Frequency of Injuries by Contributing Circumstance 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", ContributingCircumstance1 != "NA", 
         ContributingCircumstance1 != "NaN", 
         ContributingCircumstance1 != "Unable to determine", 
         ContributingCircumstance1 != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=ContributingCircumstance1)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Contributing Circumstance",
       x = "Contributing Circumstance",
       y = "Percentage")
```

### Frequency of Injuries by Person Type 

Pedestrians are most likely to die, followed by pedalcyclists most likely due to lack of protection and high exposure to the environment. Driver's are slightly less likely to be injured than passengers. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", PersonType != "NA", 
        PersonType != "NaN", PersonType != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=PersonType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Person Type",
       x = "Person Type",
       y = "Percentage")
```

### Frequency of Injury by Ejection 

Total ejection leads to the most deaths and injuries, followed by partial ejection, and not being ejection leads to the least amount of injury. Ejection most likely leads to more severe injuries due to the car crash being significant enough to lead to ejection as well the injuries that occur from being ejected as well. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Ejection != "NA", 
         Ejection != "NaN", Ejection != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=Ejection)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Ejection",
       x = "Ejection",
       y = "Percentage")
```

### Frequency of Injury by Road Feature 

Driveways tend to lead to the least amount of injuries probably due to the slow speed that people are going when in driveways. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", RoadFeature != "NA", 
         RoadFeature != "NaN", RoadFeature != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=RoadFeature)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Road Feature",
       x = "Road Feature",
       y = "Percentage")
```

### Frequency of Injury by Road Classification 

Public vehicular areas and private roads/driveways lead to the least amount of injuries. This may be because these areas are minimally trafficked and are usually at slower speeds than other roads. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", RoadClassification != "NA", 
         RoadClassification != "NaN", RoadClassification != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=RoadClassification)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Road Classification",
       x = "Road Classification",
       y = "Percentage")
```

### Frequency of Injury by Weather Condition 

Rain and sleet, hail, freezing rain/drizzle leads to the most disabling type injuries. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", WeatherCondition1 != "NA", 
         WeatherCondition1 != "NaN") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=WeatherCondition1)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Weather Condition",
       x = "Weather Condition",
       y = "Percentage")
```

### Frequency of Injury by Alcohol Result Type 

The most people are killed when there are no alcohol or other drugs. This is slightly surprising, however, it may be because when people are driving with drugs or alcohol in their system, they may attempt to be more cautious so that they do not get pulled over by police. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", AlcoholResultType != "NA", 
         AlcoholResultType != "NaN", AlcoholResultType != "Unknown",
         AlcoholResultType != "Contaminated sample/unusable", 
         AlcoholResultType != "Pending") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=AlcoholResultType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Alcohol Result Type",
       x = "Alcohol Result Type",
       y = "Percentage")
```

### Frequency of Injury by Traffic Control Type

Places where warning signs are post led to the post injuries including people killed. This may be because the signs are not taken as seriously and are less common to see, therefore, more people may disregard the warnings. Not many injuries occur near Railroad crossings. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", TrafficControlType != "NA", 
         TrafficControlType != "NaN") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=TrafficControlType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() +
  labs(title = "Injury Frequency by Traffic Control Type",
       x = "Traffic Control Type",
       y = "Percentage")
```

### Frequency of Injury by Vehicle Type

Pedestrian were the most killed, followed by motorcycles and motor scooters. This makes sense because these people are more exposed to conditions as well as generally having less protection than people in enclosed vehicles. Large vehicles like buses, trucks, and military vehicles, had the leaast amount of injuries most likely due to their large size. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", VehicleType != "NA", 
         VehicleType != "NaN", VehicleType != "Unknown", VehicleType != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=VehicleType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Vehicle Type",
       x = "Vehicle Type",
       y = "Percentage")
```

### Frequency of Injury by Protection

The most injuries occurred when people were using reflective clothing, lighting, and a helmet as protection. This makes sense because people using this would most likely be pedestrians or bikers, both of which are more exposed to danger and to having more significant injuries. Shoulder belts, lap belts, and the combination between the two appear to help decrease the amount of injuries that occur. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Protection != "NA", 
         Protection != "NaN", Protection != "Unable to determine") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=Protection)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Protection",
       x = "Protection",
       y = "Percentage")
```

### Frequency of Injury by Vision Obstruction 

Signs and embankment led to the most people being killed. This may be because these are both stationary opaque objects that will continuously block people's views of the road and conditions. Also being blinded by other lights led to the most disabling injuries. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", VisionObstruction != "NA", 
         VisionObstruction != "NaN") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=VisionObstruction)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequncy by Vision Obstruction",
       x = "Vision Obstruction",
       y = "Percentage")
```

### Frequency of Injury by Airbag Deployed 

When airbags were not deployed, there was a smaller amount of injuries. This may be because the crashes were not significant enough to cause the airbags to deploy, therefore, if the crash is not significant enough to cause airbags to deploy, the people in the crash were less likely to be harmed. When there were no airbags, there was not many injuries. This may be because cars without airbags tend to be older cars which may mean they cannot go fast enough to lead to an extremely dangerous car crash. When both front and side airbags deploy, there are a significant amount of injuries including disabling injuries. This may be due to the crash being bad enough to deploy the airbags, therefore, if the crash is bad enough, the people are more likely to be injured. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", AirbagDeployed != "NA", 
         AirbagDeployed != "NaN", AirbagDeployed != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=AirbagDeployed)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequncy by Airbag Deployed",
       x = "Airbag Deployed",
       y = "Percentage")
```

### Frequency of Injury by First Harmful Event

The first harmful event that led to the second most people killed and disabling injuries was with pedestrians. This would make sense because pedestrians often do not have protection from cars. Overturn/rollover harmful events had the most amount of injuries. Backing up had the least amount of injuries which would make sense because when backing a car up, people tend to be going a slower speed than if they were accelerating forward.

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", FirstHarmfulEvent != "NA", 
         FirstHarmfulEvent != "NaN", FirstHarmfulEvent != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=FirstHarmfulEvent)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by First Harmful Event",
       x = "First Harmful Event",
       y = "Percentage")
```

### Frequency of Injury by Most Harmful Event 

The most harmful event that led to most people killed and disabling injuries was with pedestrians. This would make sense because pedestrians often do not have protection from cars. Overturn/rollover harmful events also had a significant amount of injuries. Backing up had the least amount of injuries which would make sense because when backing a car up, people tend to be going a slower speed than if they were accelerating forward. 

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", MostHarmfulEvent != "NA", 
         MostHarmfulEvent != "NaN", MostHarmfulEvent != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=MostHarmfulEvent)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Most Harmful Event",
       x = "Most Harmful Event",
       y = "Percentage")
```

### Frequency of Injury by Driver Age

```{r}
# Comparing Injury to Driver Age
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Injury != "", PersonType == "Driver", Age != "NA",
         Age != "", Age != "Unknown", Age >= 5) %>%
  group_by(Injury) %>%
  mutate(shift = case_when(
    Age >= 5 & Age < 15 ~ "5-14",
    Age >= 15 & Age < 25 ~ "15-24",
    Age >= 25 & Age < 35 ~ "25-34",
    Age >= 35 & Age < 45 ~ "35-44",
    Age >= 45 & Age < 55 ~ "45-54",
    Age >= 55 & Age < 65 ~ "55-64",
    Age >= 65 & Age < 75 ~ "65-74",
    Age >= 75 & Age < 85 ~ "75-84",
    Age >= 85 & Age < 95 ~ "85-94",
    Age >= 95 & Age < 105 ~ "95-104",
    Age >= 105 & Age < 115 ~ "105-114",
    TRUE ~ "115-124")) %>%
  ggplot(aes(fill=Injury, x=shift)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Driver Age",
       x = "Age",
       y = "Percentage")
```

### Frequncy of Injury by Passenger Age

```{r}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Injury != "", PersonType == "Passenger", Age != "NA",
         Age != "", Age != "Unknown") %>%
  group_by(Injury) %>%
  mutate(shift = case_when(
    Age >= 0 & Age < 10 ~ "0-9",
    Age >= 10 & Age < 20 ~ "10-19",
    Age >= 20 & Age < 30 ~ "20-29",
    Age >= 30 & Age < 40 ~ "30-39",
    Age >= 40 & Age < 50 ~ "40-49",
    Age >= 50 & Age < 60 ~ "50-59",
    Age >= 60 & Age < 70 ~ "60-69",
    Age >= 70 & Age < 80 ~ "70-79",
    Age >= 80 & Age < 90 ~ "80-89",
    Age >= 90 & Age < 100 ~ "90-99",
    Age >= 100 & Age < 110 ~ "100-109",
    Age >= 110 & Age < 120 ~ "110-119",
    TRUE ~ "120-129")) %>%
  ggplot(aes(fill=Injury, x=shift)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Passenger Age",
       x = "Age",
       y = "Percentage")
```

### Frequency of Crashes by Protection

The highest frequency of crashes occured when drivers and passengers wore a shoulder and lap belt protection which are common protections in more recent vehicles. However, the second highest frequency of crashes occured when drivers and passengers had used no protection. Could this be because the vehicles they were driving didn't provide protection or that the vehicles had protection, the people just chose not to use any. 

```{r}
crashes %>% 
  filter(Protection != "NA", Protection != "Unable to determine") %>%
  count(Protection) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         Protection = reorder(Protection,logtrans)) %>% 
  ggplot(aes(x=Protection, y=logtrans, fill=Protection)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Protection",
       x = "Protection",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Trapped

More crashes resulted in people in the vehicle not being trapped than people in the vehicle being trapped. 

```{r}
crashes %>% 
  filter(Trapped != "NA", Trapped != "Unknown") %>%
  count(Trapped) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         Trapped = reorder(Trapped,logtrans)) %>% 
  ggplot(aes(x=Trapped, y=logtrans, fill=Trapped)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Trapped",
       x = "Trapped",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Vision Obstruction

The highest frequency of crashes occured when there was was no vision obstruction. It is interesting to note, that "Blinded, sunlight" led to a significant amount of crashes. When looking at the variable Weather Condition, most of the time the Weather Condition was clear. The weather was clear, however, this may have led to the sun being brighter and more likely to cause a car crash due to vision obstruction. 

```{r}
crashes %>% 
  filter(VisionObstruction != "NA", VisionObstruction != "Unknown") %>%
  count(VisionObstruction) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         VisionObstruction = reorder(VisionObstruction,logtrans)) %>% 
  ggplot(aes(x=VisionObstruction, y=logtrans, fill=VisionObstruction)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Vision Obstruction",
       x = "Vision Obstruction",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Contributing Circumstance 1

The highest frequency of crashes had no contributing circumstances indicated. 

```{r}
crashes %>% 
  filter(ContributingCircumstance1 != "NA", ContributingCircumstance1 != "Unknown") %>%
  count(ContributingCircumstance1) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         ContributingCircumstance1 = reorder(ContributingCircumstance1,logtrans)) %>% 
  ggplot(aes(x=ContributingCircumstance1, y=logtrans, fill=ContributingCircumstance1)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Contributing Circumstance 1",
       x = "Contributing Circumstance 1",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Contributing Circumstance 2

The highest frequency of crashes had inattention as a contributing circumstance 2. 

```{r}
crashes %>% 
  filter(ContributingCircumstance2 != "NA", 
         ContributingCircumstance2 != "Unknown") %>%
  count(ContributingCircumstance2) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         ContributingCircumstance2 = reorder(ContributingCircumstance2,
                                             logtrans)) %>% 
  ggplot(aes(x=ContributingCircumstance2, y=logtrans, 
             fill=ContributingCircumstance2)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Contributing Circumstance 2",
       x = "Contributing Circumstance 2",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Contributing Circumstance 3

The higest frequency of crashes had inattention as a contributing circumstance 3. 

```{r}
crashes %>% 
  filter(ContributingCircumstance3 != "NA", 
         ContributingCircumstance3 != "Unknown") %>%
  count(ContributingCircumstance3) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         ContributingCircumstance3 = 
           reorder(ContributingCircumstance3,logtrans)) %>% 
  ggplot(aes(x=ContributingCircumstance3, y=logtrans, 
             fill=ContributingCircumstance3)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Contributing Circumstance 3",
       x = "Contributing Circumstance 3",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Location Relation to Road 

```{r}
crashes %>% 
  filter(LocationRelationToRoad != "NA", LocationRelationToRoad != "Unknown") %>%
  count(LocationRelationToRoad) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationRelationToRoad = reorder(LocationRelationToRoad,logtrans)) %>% 
  ggplot(aes(x=LocationRelationToRoad, y=logtrans, fill=LocationRelationToRoad)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Location of Crash in Relation to Road",
       x = "Location Relation to Road",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Location In Near Indicator

```{r}
crashes %>% 
  filter(LocationInNearIndicator != "NA", LocationInNearIndicator != "Unknown") %>%
  count(LocationInNearIndicator) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationInNearIndicator = reorder(LocationInNearIndicator,logtrans)) %>% 
  ggplot(aes(x=LocationInNearIndicator, y=logtrans, fill=LocationInNearIndicator)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Crashes Near Indicator",
       x = "Location in Near Indicator",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Location Ramp Indicator 

```{r}
crashes %>% 
  filter(LocationRampIndicator != "NA", LocationRampIndicator != "Unknown") %>%
  count(LocationRampIndicator) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationRampIndicator = reorder(LocationRampIndicator,logtrans)) %>% 
  ggplot(aes(x=LocationRampIndicator, y=logtrans, fill=LocationRampIndicator)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Crash Location from Ramp",
       x = "Location Ramp Indicator",
       y = "Count (log10 Scale)")
```

### Histogram of Crash Location Feet From Road 

```{r}
crashes %>%
  filter(LocationFeetFromRoad != "NA", LocationFeetFromRoad != "Unknown", 
         LocationFeetFromRoad != "") %>%
  ggplot() +
  geom_histogram(aes(x=LocationFeetFromRoad), binwidth = 100, col="red", fill="darkgrey") +
  labs(title="Histogram for Location Feet From Road")
```

### Frequency of Crashes by Location Direction From Road

```{r}
crashes %>% 
  filter(LocationDirectionFromRoad != "NA", LocationDirectionFromRoad != "Unknown",
         LocationDirectionFromRoad != "") %>%
  count(LocationDirectionFromRoad) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationDirectionFromRoad= reorder(LocationDirectionFromRoad,logtrans)) %>% 
  ggplot(aes(x=LocationDirectionFromRoad, y=logtrans, fill=LocationDirectionFromRoad)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Direction of Crash",
       x = "Location Direction From Road",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Location From Indicator

```{r}
crashes %>% 
  filter(LocationAtFromIndicator != "NA", LocationAtFromIndicator != "Unknown") %>%
  count(LocationAtFromIndicator) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationAtFromIndicator= reorder(LocationAtFromIndicator,logtrans)) %>% 
  ggplot(aes(x=LocationAtFromIndicator, y=logtrans, fill=LocationAtFromIndicator)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Indicator Crash Location",
       x = "Location At/From Indicator",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Location Direction to Road

```{r}
crashes %>% 
  filter(LocationDirectionToRoad != "NA", LocationDirectionToRoad != "Unknown") %>%
  count(LocationDirectionToRoad) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationDirectionToRoad= reorder(LocationDirectionToRoad,logtrans)) %>% 
  ggplot(aes(x=LocationDirectionToRoad, y=logtrans, fill=LocationDirectionToRoad)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Direction of Crash From Road",
       x = "Location Direction To Road",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by First Harmful Event

```{r}
crashes %>% 
  filter(FirstHarmfulEvent != "NA", FirstHarmfulEvent != "Unknown") %>%
  count(FirstHarmfulEvent) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         FirstHarmfulEvent= reorder(FirstHarmfulEvent,logtrans)) %>% 
  ggplot(aes(x=FirstHarmfulEvent, y=logtrans, fill=FirstHarmfulEvent)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "First Harmful Crash Event ",
       x = "First Harmful Event",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Most Harmful Event

```{r}
crashes %>% 
  filter(MostHarmfulEvent != "NA", MostHarmfulEvent != "Unknown") %>%
  count(MostHarmfulEvent) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         MostHarmfulEvent= reorder(MostHarmfulEvent,logtrans)) %>% 
  ggplot(aes(x=MostHarmfulEvent, y=logtrans, fill=MostHarmfulEvent)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Most Harmful Crash Event ",
       x = "Most Harmful Event",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Road Classification

```{r}
crashes %>% 
  filter(RoadClassification != "NA", RoadClassification != "Unknown", 
         RoadClassification != "") %>%
  count(RoadClassification) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         RoadClassification= reorder(RoadClassification,logtrans)) %>% 
  ggplot(aes(x=RoadClassification, y=logtrans, fill=RoadClassification)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Classification of the Road ",
       x = "Road Classification",
       y = "Count (log10 Scale)")
```

### Frequency of Crashes by Crash Date Year

```{r}
crashes %>% 
  filter(Crash_Date_Year != "Unknown", Crash_Date_Year != "2011") %>%
  ggplot(aes(Crash_Date_Year, fill=as.factor(Crash_Date_Year))) +
  geom_bar(show.legend = FALSE) +
  geom_text(stat="count", aes(x=Crash_Date_Year, label=..count..), vjust=-0.25) + 
  geom_abline(intercept = 387995/(77/12), slope = 0, lty="dashed") +
  scale_x_continuous(breaks=2015:2021) +
  labs(title = "Frequency of Crashes by Year", 
       x = "Year", 
       y = "Count")
```

### Number of Drivers per Crash

```{r}
crashes %>% 
  filter(PersonType == "Driver") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Drivers = n, Frequency = nn) %>%
  mutate(Drivers = reorder(Drivers, Frequency)) %>%
  ggplot(aes(x=Drivers, y=Frequency, fill=Drivers)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.1) +
  coord_flip() +
  labs(title = "Number of Drivers per Crash",
       x = "Number of Drivers",
       y = "Count")
```

### Number of Passengers per Crash

```{r}
crashes %>% 
  filter(PersonType == "Passenger") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Passengers = n, Frequency = nn) %>%
  mutate(Passengers = reorder(Passengers,Frequency)) %>% 
  ggplot(aes(x=Passengers, y=Frequency, fill=Passengers)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Passengers per Crash",
       x = "Number of Passengers",
       y = "Count")
```

### Number of Pedestrians per Crash

```{r}
crashes %>% 
  filter(PersonType == "Pedestrian") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>% 
  rename(Pedestrians = n, Frequency = nn) %>%
  mutate(Pedestrians = reorder(Pedestrians,Frequency)) %>% 
  ggplot(aes(x=Pedestrians, y=Frequency, fill=Pedestrians)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Pedestrians per Crash",
       x = "Number of Pedestrians",
       y = "Count")
```

### Number of Pedalcyclists per Crash

```{r}
crashes %>% 
  filter(PersonType == "Pedalcyclist") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Pedalcyclists = n, Frequency = nn) %>%
  mutate(Pedalcyclists = reorder(Pedalcyclists,Frequency)) %>% 
  ggplot(aes(x=Pedalcyclists, y=Frequency, fill=Pedalcyclists)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Pedalcyclists per Crash",
       x = "Number of Pedalcyclists",
       y = "Count")
```

### Number of Other People per Crash

```{r}
crashes %>% 
  filter(PersonType == "Other*") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Other = n, Frequency = nn) %>%
  mutate(Other = reorder(Other,Frequency)) %>% 
  ggplot(aes(x=Other, y=Frequency, fill=Other)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Others per Crash",
       x = "Number of Others",
       y = "Count")
```

### Number of Unknown People per Crash

```{r}
crashes %>% 
  filter(PersonType == "Unknown") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Unknown = n, Frequency = nn) %>%
  mutate(Unknown = reorder(Unknown,Frequency)) %>% 
  ggplot(aes(x=Unknown, y=Frequency, fill=Unknown)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Unknown per Crash",
       x = "Number of Unknown",
       y = "Count")
```

### Number of People Killed per Crash

```{r}
crashes %>% 
  filter(Injury == "Killed") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Killed = n, Frequency = nn) %>%
  mutate(Killed = reorder(Killed, Frequency)) %>%
  ggplot(aes(x=Killed, y=Frequency, fill=Killed)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number Killed per Crash",
       x = "Number Killed",
       y = "Count")
```

### Number of Type A Injuries per Crash

```{r}
crashes %>% 
  filter(Injury == "A type injury (disabling)") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(TypeA = n, Frequency = nn) %>%
  mutate(TypeA = reorder(TypeA, Frequency)) %>%
  ggplot(aes(x=TypeA, y=Frequency, fill=TypeA)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Type A Injuries per Crash",
       x = "Number of Type A Injuries",
       y = "Count")
```

### Number of Type B Injuries per Crash 

```{r}
crashes %>% 
  filter(Injury == "B type injury (evident)") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(TypeB = n, Frequency = nn) %>%
  mutate(TypeB = reorder(TypeB, Frequency)) %>%
  ggplot(aes(x=TypeB, y=Frequency, fill=TypeB)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Type B Injuries per Crash",
       x = "Number of Type B Injuries",
       y = "Count")
```

### Number of Type C Injuries per Crash

```{r}
crashes %>% 
  filter(Injury == "C type injury (possible)") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(TypeC = n, Frequency = nn) %>%
  mutate(TypeC = reorder(TypeC, Frequency)) %>%
  ggplot(aes(x=TypeC, y=Frequency, fill=TypeC)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Type C Injuries per Crash",
       x = "Number of Type C Injuries",
       y = "Count")
```

### Number of People with No Injuries per Crash 

```{r}
crashes %>% 
  filter(Injury == "No injury") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(NoInjury = n, Frequency = nn) %>%
  mutate(NoInjury = reorder(NoInjury, Frequency)) %>%
  ggplot(aes(x=NoInjury, y=Frequency, fill=NoInjury)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of People with No Injuries per Crash",
       x = "Number of People with No Injuries",
       y = "Count")
```

### Number of Unknown Injuries per Crash

```{r}
crashes %>% 
  filter(Injury == "Unknown") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Unknown = n, Frequency = nn) %>%
  mutate(Unknown = reorder(Unknown, Frequency)) %>%
  ggplot(aes(x=Unknown, y=Frequency, fill=Unknown)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Unknown Injuries per Crash",
       x = "Number of Unknown Injuries",
       y = "Count")
```

## Visualizing data using maps 

### Map of Crash Locations (North Carolina)

```{r}
crashes %>% 
  filter(LocationLatitude != "0", LocationLongitude != "0",
         LocationLatitude != "NA", LocationLatitude != "",
         LocationLongitude != "NA", LocationLongitude != "",
         LocationLatitude > 35.4, LocationLatitude < 36.2,
         LocationLongitude < -78, LocationLongitude > -79) %>%
  ggplot(aes(LocationLongitude, LocationLatitude)) +
  borders('county', 'north carolina', fill = "light blue") +
  geom_point(size=0.5, col = 'black', show.legend = F) +
  coord_quickmap()
```

### Map of Crash Locations (Wake County)

#### Install necessaary packages

```{r}
library(maps)
#install.packages("sf")
library(sf)
```

#### Create map 

From the map, we can see that many crashes occur near the center of Wake County. This makes sense because in the center of Wake County sits Raleigh, the capital of North Carolina. 

```{r}
nc_counties <- map_data("county", "north carolina") %>%
  select(lon = long, lat, group, id = subregion)
head(nc_counties)

wake_county <- nc_counties %>%
  filter(nc_counties$id == "wake")

wake_map <- wake_county %>% 
  ggplot() +
  geom_polygon(aes(lon, lat), color = "darkblue", fill = "lightblue")
wake_map

crashes_filter <- crashes %>%
  filter(LocationLatitude != "0", LocationLongitude != "0",
         LocationLatitude != "NA", LocationLatitude != "",
         LocationLongitude != "NA", LocationLongitude != "",
         LocationLatitude > 35.4, LocationLatitude < 36.2,
         LocationLongitude < -78, LocationLongitude > -79)

wake_map <- wake_map + 
  geom_point(data = crashes_filter, aes(x=LocationLongitude, y= LocationLatitude), colour = "blue", alpha = 1/10)
wake_map
```

### Heat Map of Crash Locations (Wake County)

#### Load necessary packages
```{r}
library(ggplot2)
#install.packages("ggmap")
library(ggmap)
library(RColorBrewer)
```

#### Create map (zoomed-out version)

```{r}
map_bounds <- c(-78.98, 35.51, -78.24, 36.06)

coords.map <- get_stamenmap(map_bounds, zoom = 10, maptype = "toner-lite")

coords.map <- ggmap(coords.map, extent="panel", legend="none")
coords.map <- coords.map + stat_density2d(data=crashes_filter,  
                                          aes(x=LocationLongitude, 
                                              y=LocationLatitude, 
                                              fill=..level.., 
                                              alpha=..level..), 
                                          geom="polygon")
coords.map <- coords.map +   scale_fill_gradientn(colours=rev(brewer.pal(7, "RdBu")))

coords.map <- coords.map + theme_bw()

coords.map
```

#### Create map (zoomed-in version)

From the Wake County heat map, we can see that crashes are much more likely to occur in the center of the city. We see that as more streets populate an area, more crashes occur. 

```{r}
crashes_filter <- crashes %>%
  filter(LocationLatitude != "0", LocationLongitude != "0",
         LocationLatitude != "NA", LocationLatitude != "",
         LocationLongitude != "NA", LocationLongitude != "",
         LocationLatitude > 35.4, LocationLatitude < 36.2,
         LocationLongitude < -78, LocationLongitude > -79)

map_bounds <- c(-78.8, 35.68, -78.5, 35.9) #coordinates of wake county

coords.map <- get_stamenmap(map_bounds, zoom = 13, maptype = "toner-lite")

coords.map <- ggmap(coords.map, extent="panel", legend="none")
coords.map <- coords.map + stat_density2d(data=crashes_filter,  
                                          aes(x=LocationLongitude, 
                                              y=LocationLatitude, 
                                              fill=..level.., 
                                              alpha=..level..), 
                                          geom="polygon")
coords.map <- coords.map +   scale_fill_gradientn(colours=rev(brewer.pal(7, "Spectral")))

coords.map <- coords.map + theme_bw()

coords.map
```

## Visualizing text data using word clouds 

### Installing and loading necessary packages 

```{r}
devtools::install_github("gaospecial/wordcloud2")
```

```{r}
#install.packages('wordcloud2')
library(wordcloud2)
```

### Word Cloud for Location Road Name On  

From the word cloud, we can see many crashes occur on 440, 40, and Capital Blvd. This makes sense because 440 and 40 are major interstates that connect to several major junctions and Capital Blvd is a main road in North Carolina as well. 

```{r}
location_road_name_on_freq <- crashes %>%
  count(LocationRoadNameOn)

set.seed(101)
location_road_name_on_freq %>%
  wordcloud2(shape = 'circle', backgroundColor = "black", minSize = 5)
```

### Word cloud for location road name at

From the word cloud, we can see that 440, Capital Blvd, 40, and Blue Ridge Rd frequently have crashes that are near by. This would make sense because most of these streets are highly trafficked and populated. 

```{r}
location_road_name_at_freq <- crashes %>%
  count(LocationRoadNameAt)

set.seed(102)
location_road_name_at_freq %>%
  wordcloud2(shape = 'circle', backgroundColor = "black", minSize = 5)
```

## Visualizing data using time series plots

### Time Series Plot for Frequency of Crashes Everyday (from January 2015 to May 2021)

From the plot, we see that there are major spikes around March 2015, late October 2015, and December 2016. The two latter spikes may be related to the popular holidays, Halloween and Christmas. 

From the time series plot, we can see that there is a significant drop in car crashes in March 2020. This can be explained by the stay-at-home-orders due to the COVID-19 pandemic. After the stay at home orders, the frequency of crashes seems to be slightly lower throughout May 2021. There will likely be an increase in the next few month due to stay-at-home-orders and COVID-19 regulations being lifted now that the vaccination is available. 

```{r}
crashes_ts = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date) %>%
  summarize(count = length(unique(key_crash)))

crashes_ts %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  geom_line() + 
  scale_x_date(date_labels = "%m-%Y", date_breaks = "6 month") + 
  theme(axis.text.x = element_text(angle = 90))
```
