---
title: "Visualizing, Modeling and Forecasting Crashes in Wake County, North Carolina"
author: "Cortlyn Morris, Kelly Wentzlof, Ayan Gulzar"
date: "6/11/2021"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading-libraries, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}
library(reshape2)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(dslabs)
library(ggrepel)
library(ggthemes)
library(maps)
library(scales)
library(zoo)
```

```{r set-directory, echo=FALSE, include=FALSE}
#setwd("/Users/cmorris/Desktop/dsreu2021/rstudiodirectory/ResearchProject")
```

```{r read-data, message=FALSE, echo=FALSE, include=FALSE}
#Code for Cortlyns computer (Mac)
 # setwd("/Users/cmorris/Desktop/dsreu2021/rstudiodirectory/ResearchProject")
 # persons <- read.csv(file="Persons_Involved_in_Crashes.csv")
 # glimpse(persons)
 #    
 # locations <- read.csv(file="Reported_Crash_Locations.csv")
 # glimpse(locations)
 #    
 # crashes <- persons %>% left_join(locations, by="key_crash")

#Code for Kelly's computer (Windows)
#library(readr)
persons <- read_csv("~/NCAT REU/Mostafa/Data/Persons_Involved_in_Crashes.csv")

locations <- read_csv("~/NCAT REU/Mostafa/Data/Reported_Crash_Locations.csv")

crashes <- persons %>% left_join(locations, by="key_crash")

# Code for Ayan's computer (Window)
#library(readr)
# persons <- read_csv("C:/Users/ayang/Desktop/Project FIles REU A&T/REU Research Project1/Persons_Involved_in_Crashes.csv")
# 
# locations <- read_csv("C:/Users/ayang/Desktop/Project FIles REU A&T/REU Research Project1/Reported_Crash_Locations.csv")
# 
# crashes <- persons %>% left_join(locations, by="key_crash")
```

## Exploratory Data Analysis 

### Univariate Explorations

The highest frequency of crashes occur in a passenger car. However, this is not very surprising because passenger cars are relatively common. An interesting note is that sport utility vehicles have the second highest frequency of crashes, however, sport utility vehicles are not nearly as common of a car.

```{r vehicle-type, echo=FALSE}
crashes %>% 
  filter(VehicleType != "Unknown", VehicleType != "") %>%
  count(VehicleType) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         VehicleType = reorder(VehicleType,logtrans)) %>% 
  ggplot(aes(x=VehicleType, y=logtrans, fill=VehicleType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) + 
  labs(title = "Frequency of Crashes by Vehicle Type", 
       x = "Vehicle Type", 
       y = "Count (log10 Scale)")
```

The highest frequency of crashes occur when the weather conditions are clear. This is not very surprising because in North Carolina, the majority of the time the weather is clear. An interesting note is that snow still has a relatively high frequency despite it snowing minimally in North Carolina. 

```{r weather-condition, echo=FALSE}
crashes %>% 
  filter(WeatherCondition1 != "NA") %>%
  count(WeatherCondition1) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         WeatherCondition1 = reorder(WeatherCondition1,logtrans)) %>% 
  ggplot(aes(x=WeatherCondition1, y=logtrans, fill=WeatherCondition1)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Weather Condition",
       x = "Weather Condition",
       y = "Count (log10 Scale)")
```

When looking at the weather conditions for only those crashes where it was believed that weather was a contribution factor in the crash, we can see that rain jumps from third most frequent to first. This is not something unexpected because heavy rain conditions make driving much harder and can cause things such as hydroplaning to happen. Clear weather is now the second most common which is slightly surprising because clear weather is not typically associated with causing car crashes but since it is the most common weather type, we can better understand this conclusion. Although the order of which weather conditions are the most frequent when looking only at the crashes where the weather contributed, there is still the same number of weather types.

```{r weather, echo=FALSE}
crashes %>% 
  filter(WeatherCondition1 != "NA", WeatherContributedToCrash == "Yes") %>%
  count(WeatherCondition1) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         WeatherCondition1 = reorder(WeatherCondition1,logtrans)) %>% 
  ggplot(aes(x=WeatherCondition1, y=logtrans, fill=WeatherCondition1)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = 
  "Frequency of Crashes by Weather Condition and if Weather Contributed to Crash",
       x = "Weather Condition",
       y = "Count (log10 Scale)") + 
  theme(title = element_text(size = 8))
```

The highest frequency of crashes occur when there is no traffic control present. Without a control present, drivers may be less confident in their actions. 

```{r traffic-control, echo=FALSE}
crashes %>% 
  filter(TrafficControlType != "NA", TrafficControlType != "", 
         TrafficControlType != "NaN") %>%
  count(TrafficControlType) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         TrafficControlType = reorder(TrafficControlType,logtrans)) %>% 
  ggplot(aes(x=TrafficControlType, y=logtrans, fill=TrafficControlType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Traffic Control Type",
       x = "Traffic Control Type",
       y = "Count (log10 Scale)")
```

The highest frequency of crashes occur when there is no special road feature present. Without a road feature present, drivers may be less confident in their actions. 

```{r road-feat, echo=FALSE}
crashes %>% 
  filter(RoadFeature != "NA", RoadFeature != "", RoadFeature != "NaN") %>%
  count(RoadFeature) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         RoadFeature = reorder(RoadFeature,logtrans)) %>% 
  ggplot(aes(x=RoadFeature, y=logtrans, fill=RoadFeature)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Road Feature",
       x = "Road Feature",
       y = "Count (log10 Sclae)")
```

We were surprised to see that the ages of drivers had such a wide range with the maximum age of a driver being 120 years old. 

```{r person-type, echo=FALSE}
crashes %>%
  filter(PersonType == "Driver", Age != "NA", Age != "NaN", Age != "") %>%
  ggplot() +
  geom_histogram(aes(x=Age), binwidth = 5, col="red", fill="darkgrey") +
  labs(title="Histogram for Drivers' Ages", x="Age", y="Frequency")
```

```{r alcohol-result, echo=FALSE}
crashes %>% 
  filter(AlcoholResultType != "NA", AlcoholResultType != "", 
         AlcoholResultType != "NaN", AlcoholResultType != "Contaminated sample/unusable") %>%
  count(AlcoholResultType) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         AlcoholResultType = reorder(AlcoholResultType,logtrans)) %>% 
  ggplot(aes(x=AlcoholResultType, y=logtrans, fill=AlcoholResultType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Alcohol Result Type",
       x = "Alcohol Result Type",
       y = "Count (log10 Scale)")
```

```{r alcohol-result-filter, echo=FALSE}
crashes %>% 
  filter(AlcoholResultType != "NA", AlcoholResultType != "", 
         AlcoholResultType != "NaN", AlcoholResultType != 
           "Contaminated sample/unusable", AlcoholResultType != "Pending",
         AlcoholResultType != "Unknown") %>%
  count(AlcoholResultType) %>% 
  mutate(logtrans = round(log10(n), digits = 2),
         AlcoholResultType = reorder(AlcoholResultType,logtrans)) %>% 
  ggplot(aes(x=AlcoholResultType, y=logtrans, fill=AlcoholResultType)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() + 
  geom_text(aes(label=logtrans),nudge_y=0.5) +
  labs(title = "Frequency of Crashes by Alcohol Result Type",
       x = "Alcohol Result Type",
       y = "Count (log10 Scale)")
```

```{r crash-dow, echo=FALSE}
crashes %>% 
  filter(Crash_Date_DOW != "NA") %>%
  mutate(Crash_Date_DOW = factor(Crash_Date_DOW, levels = c("Sunday","Monday", "Tuesday", "Wednesday", 
                                   "Thursday", "Friday", "Saturday"))) %>%
  ggplot() +
  geom_bar(aes(Crash_Date_DOW, fill=Crash_Date_DOW), show.legend = FALSE) +
  geom_text(stat="count", aes(x=Crash_Date_DOW, label=..count..), vjust=-0.25) +
  labs(title = "Frequency of Crashes by Day of Week",
       x = "Day of Week",
       y = "Count")
```

```{r crash-month, echo=FALSE}
crashes %>% 
  filter(Crash_Date_Month != "NA") %>%
  mutate(Crash_Date_Month = factor(Crash_Date_Month, 
                                   levels = c("January","February",
                                              "March", "April",
                                              "May", "June", "July",
                                              "August", "September",
                                              "October", "November",
                                              "December"))) %>%
  ggplot() +
  geom_bar(aes(Crash_Date_Month, fill=Crash_Date_Month), show.legend = FALSE) +
  geom_text(stat="count", aes(x=Crash_Date_Month, label=..count..), vjust=-0.25) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Frequency of Crashes by Month",
       x = "Month",
       y = "Count")
```

```{r crash-hour, echo=FALSE, include=FALSE}
crashes %>%
  filter(Crash_Date_Hour != "NA", Crash_Date_Hour != "") %>%
  ggplot() +
  geom_bar(aes(Crash_Date_Hour)) +
  labs(title="Frequency of Crashes by Hour", x="Hour", y="Count")
```

```{r crash-shift, echo=FALSE}
crashes %>%
  filter(Crash_Date_Hour != "NA", Crash_Date_Hour != "") %>%
  mutate(shift = case_when(
    Crash_Date_Hour >= 6 & Crash_Date_Hour < 14 ~ "6:00 a.m. - 1:59 p.m.",
    Crash_Date_Hour >= 14 & Crash_Date_Hour < 22 ~ "2:00 p.m. - 9:59 p.m.",
    TRUE ~ "10:00 p.m. - 5:59 a.m.")) %>%
  mutate(shift = factor(shift, levels = c("6:00 a.m. - 1:59 p.m.", 
                                          "2:00 p.m. - 9:59 p.m.", 
                                          "10:00 p.m. - 5:59 a.m."))) %>%
  ggplot() +
  geom_bar(aes(x=shift, fill = shift), show.legend = F) +
  labs(title="Frequency of Crashes by Shift", x="Shift", y="Count")
```

The range of drivers' ages is from about 16 to 100. The range of passengers' ages is from about 0 to 100. The range of drivers' ages is slightly larger due to the age restrictions for getting a license. 

```{r driver-passenger-age, echo=FALSE}
crashes %>% 
  filter(PersonType == "Driver" | PersonType == "Passenger", Age != "", Age != "NA") %>% 
  ggplot() +
  geom_histogram(aes(x=Age), binwidth = 5, col="red", fill="darkgrey") +
  labs(x="Age", y="Frequency", title="Drivers' vs. Passengers' Age") +
  theme(legend.position = "top") +
  facet_wrap(~PersonType, dir = "v")
```

There are slighlty more male drivers in Wake County getting in crashes than female drivers. Additionally, there are slightly more female passengers in Wake County car crashes than male passengers. 

```{r driver-passenger-gender, echo=FALSE}
crashes %>% 
  filter(PersonType == "Driver" | PersonType == "Passenger", 
         Gender != "NA", Gender != "Unknown") %>% 
  ggplot() +
  geom_bar(aes(x=Gender), col="red", fill="darkgrey") +
  labs(x="Gender", y="Frequency", title="Drivers' vs. Passengers' Gender") +
  theme(legend.position = "top") +
  facet_wrap(~PersonType)
```

About half as many vehicles were seized compared to vehicles not seized. 

```{r vehicle-seize, echo=FALSE} 
crashes %>% 
  filter(VehicleSeizure != "NA", VehicleSeizure != "") %>%
  count(VehicleSeizure) %>% 
  mutate(logtrans = round(log10(n), digits = 2)) %>% 
  ggplot(aes(x=VehicleSeizure, y=logtrans, fill=VehicleSeizure)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  labs(title = "Frequency of Crashes by Vehicle Seizure",
       x = "Vehicle Seizure",
       y = "Count (log10 Scale)")
```

The highest frequency of crashes occured where the airbags were not deployed. It is interesting to note that the second highest frequency of crashes occured where the car(s) did not have airbags to begin with. 
Airbags did not deploy during most crashes, therefore many accidents logged were minor. 

```{r airbag-deploy, echo=FALSE}
crashes %>% 
  filter(AirbagDeployed != "NA", AirbagDeployed != "Unknown", 
         AirbagDeployed != "") %>%
  count(AirbagDeployed) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         AirbagDeployed = reorder(AirbagDeployed,logtrans)) %>% 
  ggplot(aes(x=AirbagDeployed, y=logtrans, fill=AirbagDeployed)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Airbag Deployed",
       x = "Airbag Deployed",
       y = "Count (log10 Scale)")
```

Most car crashes resulted in drivers and passengers not being ejected. More people were totally ejected from the vehicle than partially ejected. 

```{r ejection, echo=FALSE}
crashes %>% 
  filter(Ejection != "NA", Ejection != "Unknown", Ejection != "") %>%
  count(Ejection) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         Ejection = reorder(Ejection,logtrans)) %>% 
  ggplot(aes(x=Ejection, y=logtrans, fill=Ejection)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Ejection",
       x = "Ejection",
       y = "Count (log10 Scale)")
```

About 3 more percent of people that get in crashes are men than women. 

```{r gender, echo=FALSE}
crashes %>% 
  filter(Gender != "NA", Gender != "Unknown", Gender != "") %>%
  count(Gender) %>% 
  mutate(Percent = round(n/sum(n)*100,2), 
         Gender = reorder(Gender,Percent)) %>% 
  ggplot(aes(x=Gender, y=Percent, fill=Gender)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label= Percent),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Gender",
       x = "Gender",
       y = "Percent")
```

According to census.gov...

In the United States, 76.3 % of people are White, 13.4% of people are Black or African American, 18.5% are Hispanic or Latina, 0.2 are Native Hawaiian and Other Pacific Islander, 2.8% are two or more races, 5.9% are Asian, 1.3% are American Indian and Alaska Native, . 

In North Carolina, 70.6 % of people are White, 22.2% of people are Black or African American, 9.8% are Hispanic or Latina, 0.1 are Native Hawaiian and Other Pacific Islander, 2.3% are two or more races, 3.2% are Asian, and 1.6% are American Indian and Alaska Native.

In Wake County, North Carolina, 67.9 % of people are White, 21.0% of people are Black or African American, 10.4% are Hispanic or Latina, 0.1% are Native Hawaiian and Other Pacific Islander, 2.6% are two or more races, 7.7% are Asian, and 0.8% are American Indian and Alaska Native.

This is interesting because, despite the percentage of Black people being less than a third of the percentage of White people, the percentage of Black people in car crashes is not far behind the percentage of White people in car crashes. 

```{r race, echo=FALSE}
crashes %>% 
  filter(Race != "NA", Race != "Unknown", Race != "") %>%
  count(Race) %>% 
  mutate(Percent = round(n/sum(n)*100,2), 
         Race = reorder(Race,Percent)) %>% 
  ggplot(aes(x=Race, y=Percent, fill=Race)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Percent), nudge_y = 0.05) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Race",
       x = "Race",
       y = "Percent")
```

The highest frequency of crashes did not result in any injury. Following the highest frequency, the more serious the injury, the less crashes occured. 

```{r injury, echo=FALSE}
crashes %>% 
  filter(Injury != "NA", Injury != "Unknown", Injury != "") %>%
  count(Injury) %>% 
  mutate(Percent = round(n/sum(n)*100, digits = 2), 
         Injury = reorder(Injury,Percent)) %>% 
  ggplot(aes(x=Injury, y=Percent, fill=Injury)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Percent),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Injury",
       x = "Injury",
       y = "Percent")
```

The highest frequency of crashes occured when drivers and passengers wore a shoulder and lap belt protection which are common protections in more recent vehicles. However, the second highest frequency of crashes occured when drivers and passengers had used no protection. Could this be because the vehicles they were driving didn't provide protection or that the vehicles had protection, the people just chose not to use any. 

```{r protection, echo=FALSE}
crashes %>% 
  filter(Protection != "NA", Protection != "Unable to determine", 
         Protection != "") %>%
  count(Protection) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         Protection = reorder(Protection,logtrans)) %>% 
  ggplot(aes(x=Protection, y=logtrans, fill=Protection)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Protection",
       x = "Protection",
       y = "Count (log10 Scale)")
```

More crashes resulted in people in the vehicle not being trapped than people in the vehicle being trapped. 

```{r trapped, echo=FALSE}
crashes %>% 
  filter(Trapped != "NA", Trapped != "Unknown", Trapped != "") %>%
  count(Trapped) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         Trapped = reorder(Trapped,logtrans)) %>% 
  ggplot(aes(x=Trapped, y=logtrans, fill=Trapped)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Trapped",
       x = "Trapped",
       y = "Count (log10 Scale)")
```

The highest frequency of crashes occured when there was was no vision obstruction. It is interesting to note, that "Blinded, sunlight" led to a significant amount of crashes. When looking at the variable Weather Condition, most of the time the Weather Condition was clear. The weather was clear, however, this may have led to the sun being brighter and more likely to cause a car crash due to vision obstruction. 

```{r vision-obstruction, echo=FALSE}
crashes %>% 
  filter(VisionObstruction != "NA", VisionObstruction != "Unknown", 
         VisionObstruction != "") %>%
  count(VisionObstruction) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         VisionObstruction = reorder(VisionObstruction,logtrans)) %>% 
  ggplot(aes(x=VisionObstruction, y=logtrans, fill=VisionObstruction)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Vision Obstruction",
       x = "Vision Obstruction",
       y = "Count (log10 Scale)")
```

The highest frequency of crashes had no contributing circumstances indicated. 

```{r contrib-circum-1, echo=FALSE}
crashes %>% 
  filter(ContributingCircumstance1 != "NA", ContributingCircumstance1 != "Unknown", 
         ContributingCircumstance1 != "Unable to determine",
         ContributingCircumstance1 != "") %>%
  count(ContributingCircumstance1) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         ContributingCircumstance1 = reorder(ContributingCircumstance1,logtrans)) %>% 
  ggplot(aes(x=ContributingCircumstance1, y=logtrans, fill=ContributingCircumstance1)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Contributing Circumstance 1",
       x = "Contributing Circumstance 1",
       y = "Count (log10 Scale)") + 
  scale_x_discrete(labels = c("Passed on hill", 
                              "Passed on curve",  
                              "Passed stopped school bus",
                              "Driver distracted by electronic", 
                              "Improper or no signal",
                              "Driver distracted by external distraction",
                              "Right turn on red",
                              "Drug use",
                              "Disregarded yield sign", 
                              "Driver distracted by communication device", 
                              "Driver distracted by passenger", 
                              "Visibility obstructed",
                              "Disregarded other traffic signs", 
                              "Driver distracted", 
                              "Disregarded road markings",
                              "Operated defective equipment",
                              "Exceeded speed limit",
                              "Disregarded stop sign",
                              "Going wrong way", 
                              "Use of improper lane",
                              "Alcohol use", 
                              "Other improper passing", 
                              "Followed too closely", 
                              "Swerved or avoided",
                              "Overcorrected/oversteered",
                              "Erratic, reckless, negligent", 
                              "Other*",
                              "Disregarded traffic signals",
                              "Exceeded safe speed",
                              "Improper parking",
                              "Improper turn",
                              "Improper lane change",
                              "Improper backing",
                              "Failed to yield", 
                              "Inattention", 
                              "Failure to reduce speed",
                              "No contributing circumstance"))
```

The highest frequency of crashes had inattention as a contributing circumstance 2. 

```{r contrib-circum-2, echo=FALSE}
crashes %>% 
  filter(ContributingCircumstance2 != "NA", 
         ContributingCircumstance2 != "Unknown", 
         ContributingCircumstance2 != "Unable to determine", 
         ContributingCircumstance2 != "") %>%
  count(ContributingCircumstance2) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         ContributingCircumstance2 = reorder(ContributingCircumstance2,
                                             logtrans)) %>% 
  ggplot(aes(x=ContributingCircumstance2, y=logtrans, 
             fill=ContributingCircumstance2)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Contributing Circumstance 2",
       x = "Contributing Circumstance 2",
       y = "Count (log10 Scale)") + 
  scale_x_discrete(labels = c("Passed on curve",  
                              "Passed on hill", 
                              "Passed stopped school bus",
                              "Disregarded yield sign", 
                              "Improper or no signal",
                              "Right turn on red",
                              "Disregarded other traffic signs", 
                              "Disregarded stop sign",
                              "Driver distracted by external distraction",
                              "Driver distracted by electronic", 
                              "Disregarded road markings",
                              "Drug use",
                              "Visibility obstructed",
                              "Swerved or avoided",
                              "Other improper passing",
                              "Exceeded speed limit",
                              "Use of improper lane",
                              "Driver distracted by communication device", 
                              "Driver distracted by passenger", 
                              "Operated defective equipment",
                              "Improper parking",
                              "No contributing circumstance", 
                              "Disregarded traffic signals",
                              "Other*",
                              "Driver distracted", 
                              "Going wrong way",
                              "Exceeded safe speed",
                              "Followed too closely", 
                              "Overcorrected/oversteered",
                              "Improper turn",
                              "Alcohol use", 
                              "Improper lane change",
                              "Erratic, reckless, negligent", 
                              "Improper backing",
                              "Failed to yield",
                              "Failure to reduce speed",
                              "Inattention"))
```

The higest frequency of crashes had inattention as a contributing circumstance 3. 
```{r contrib-cicum-3, echo=FALSE}
crashes %>% 
  filter(ContributingCircumstance3 != "NA", 
         ContributingCircumstance3 != "Unknown", 
         ContributingCircumstance3 != "Unable to determine", 
         ContributingCircumstance3 != "") %>%
  count(ContributingCircumstance3) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         ContributingCircumstance3 = 
           reorder(ContributingCircumstance3,logtrans)) %>% 
  ggplot(aes(x=ContributingCircumstance3, y=logtrans, 
             fill=ContributingCircumstance3)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Frequency of Crashes by Contributing Circumstance 3",
       x = "Contributing Circumstance 3",
       y = "Count (log10 Scale)") + 
  scale_x_discrete(labels = c("Passed on hill", 
                              "Right turn on red",
                              "Passed on curve", 
                              "Disregarded yield sign", 
                              "Improper or no signal",
                              "Disregarded other traffic signs", 
                              "Disregarded stop sign",
                              "Improper parking",
                              "No contributing circumstance", 
                              "Disregarded road markings",
                              "Visibility obstructed",
                              "Driver distracted by electronic",
                              "Swerved or avoided",
                              "Exceeded speed limit",
                              "Driver distracted by external distraction",
                              "Operated defective equipment",
                              "Other improper passing",
                              "Use of improper lane",
                              "Disregarded traffic signals",
                              "Exceeded safe speed",
                              "Improper backing",
                              "Driver distracted by communication device",
                              "Going wrong way",
                              "Driver distracted by passenger", 
                              "Other*",
                              "Improper lane change",
                              "Drug use",
                              "Improper turn",
                              "Overcorrected/oversteered",
                              "Driver distracted", 
                              "Followed too closely", 
                              "Failure to reduce speed",
                              "Failed to yield",
                              "Alcohol use", 
                              "Erratic, reckless, negligent",
                              "Inattention"))
```

Most of the crashes on the roadway. This means it includes accidents on highways, streets, and where there is a lot of traffic. 

```{r location-relation, echo=FALSE}
crashes %>% 
  filter(LocationRelationToRoad != "NA", LocationRelationToRoad != "Unknown",
         LocationRelationToRoad != "") %>%
  count(LocationRelationToRoad) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationRelationToRoad = reorder(LocationRelationToRoad,logtrans)) %>% 
  ggplot(aes(x=LocationRelationToRoad, y=logtrans, fill=LocationRelationToRoad)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Location of Crash in Relation to Road",
       x = "Location Relation to Road",
       y = "Count (log10 Scale)")
```

```{r location-in-near, echo=FALSE}
crashes %>% 
  filter(LocationInNearIndicator != "NA", LocationInNearIndicator != "Unknown",
         LocationInNearIndicator != "") %>%
  count(LocationInNearIndicator) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationInNearIndicator = reorder(LocationInNearIndicator,logtrans)) %>% 
  ggplot(aes(x=LocationInNearIndicator, y=logtrans, fill=LocationInNearIndicator)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Crashes Near Indicator",
       x = "Location in Near Indicator",
       y = "Count (log10 Scale)")
```

```{r location-ramp, echo=FALSE}
crashes %>% 
  filter(LocationRampIndicator != "NA", LocationRampIndicator != "Unknown", 
         LocationRampIndicator != "") %>%
  count(LocationRampIndicator) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationRampIndicator = reorder(LocationRampIndicator,logtrans)) %>% 
  ggplot(aes(x=LocationRampIndicator, y=logtrans, fill=LocationRampIndicator)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Crash Location from Ramp",
       x = "Location Ramp Indicator",
       y = "Count (log10 Scale)")
```

The data for the location of crashes from a road shows that most crashes happen at most popular roadways. These roadways tend to be the busiest roads. 

```{r location-feet, echo=FALSE}
crashes %>%
  filter(LocationFeetFromRoad != "NA", LocationFeetFromRoad != "Unknown", 
         LocationFeetFromRoad != "") %>%
  ggplot() +
  geom_histogram(aes(x=LocationFeetFromRoad), binwidth = 100, col="red", fill="darkgrey") +
  labs(title="Histogram for Location Feet From Road")
```

Most direction of crashes were North, South, East, and West. This shows that there is no specific direction where crashes were most common. This data implies that there is the same amount of crashes in every direction of the road. 

```{r location-direction-from, echo=FALSE}
crashes %>% 
  filter(LocationDirectionFromRoad != "NA", LocationDirectionFromRoad != "Unknown",
         LocationDirectionFromRoad != "") %>%
  count(LocationDirectionFromRoad) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationDirectionFromRoad= reorder(LocationDirectionFromRoad,logtrans)) %>% 
  ggplot(aes(x=LocationDirectionFromRoad, y=logtrans, fill=LocationDirectionFromRoad)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Direction of Crash",
       x = "Location Direction From Road",
       y = "Count (log10 Scale)")
```

More crashes tend to occur from and indicator then from the indicator. This means that most common crashes are known to happen near busy streets/roads. 

```{r location-at-from, echo=FALSE}
crashes %>% 
  filter(LocationAtFromIndicator != "NA", LocationAtFromIndicator != "Unknown") %>%
  count(LocationAtFromIndicator) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationAtFromIndicator= reorder(LocationAtFromIndicator,logtrans)) %>% 
  ggplot(aes(x=LocationAtFromIndicator, y=logtrans, fill=LocationAtFromIndicator)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Indicator Crash Location",
       x = "Location At/From Indicator",
       y = "Count (log10 Scale)")
```

When it comes to the location direction of the crash to the road the data is like location direction of crashes from road. Most crashes happen North, South, East, and West. 

```{r location-direction-to, echo=FALSE}
crashes %>% 
  filter(LocationDirectionToRoad != "NA", LocationDirectionToRoad != "Unknown") %>%
  count(LocationDirectionToRoad) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         LocationDirectionToRoad= reorder(LocationDirectionToRoad,logtrans)) %>% 
  ggplot(aes(x=LocationDirectionToRoad, y=logtrans, fill=LocationDirectionToRoad)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Direction of Crash From Road",
       x = "Location Direction To Road",
       y = "Count (log10 Scale)")
```

The data shows us that the (First Harmful Crash Event) is from a rear end, slow or stop. This implies that some drivers might be driving under the speed limit or not paying attention to what is in front of them on the road. 

```{r first-harm, echo=FALSE}
crashes %>% 
  filter(FirstHarmfulEvent != "NA", FirstHarmfulEvent != "Unknown") %>%
  count(FirstHarmfulEvent) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         FirstHarmfulEvent= reorder(FirstHarmfulEvent,logtrans)) %>% 
  ggplot(aes(x=FirstHarmfulEvent, y=logtrans, fill=FirstHarmfulEvent)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "First Harmful Crash Event ",
       x = "First Harmful Event",
       y = "Count (log10 Scale)")
```

The most harmful event is also a rear end, slow or stop accident just like the fist harmful event. Side swiped accidents and hitting parked vehicles are also pretty common accidents. This informs us that drivers are not paying attention to the road and are being distracted. 

```{r most-harm, echo=FALSE}
crashes %>% 
  filter(MostHarmfulEvent != "NA", MostHarmfulEvent != "Unknown") %>%
  count(MostHarmfulEvent) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         MostHarmfulEvent= reorder(MostHarmfulEvent,logtrans)) %>% 
  ggplot(aes(x=MostHarmfulEvent, y=logtrans, fill=MostHarmfulEvent)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Most Harmful Crash Event ",
       x = "Most Harmful Event",
       y = "Count (log10 Scale)")
```

Local streets are the most common places where there are accidents. This is because local streets tend to be busy. There is usually traffic in both directions. There are also many people walking around. This causes the driver to get distracted easily. 

```{r road-class, echo=FALSE}
crashes %>% 
  filter(RoadClassification != "NA", RoadClassification != "Unknown", 
         RoadClassification != "") %>%
  count(RoadClassification) %>% 
  mutate(logtrans = round(log10(n), digits = 2), 
         RoadClassification= reorder(RoadClassification,logtrans)) %>% 
  ggplot(aes(x=RoadClassification, y=logtrans, fill=RoadClassification)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=logtrans),nudge_y=0.2) +
  coord_flip() +
  labs(title = "Classification of the Road ",
       x = "Road Classification",
       y = "Count (log10 Scale)")
```

We included a horizontal dashed line to indicate where the yearly average lies 
and we can see that only the years 202 and 2021 fall below this yearly average. 
The year with the most crashes in 2019 but not by many. The full year with the
fewest crashes in 2020 which was to be expected due to the lockdowns that took 
place to try and mitigate the spread of Covid-19. 2021 also looks to be on track
to be another low crash year but we do not have a perfect explanation for that 
seeing as things are beginning to open and "return to normal" again.

```{r crash-year, echo=FALSE}
crashes %>% 
  filter(Crash_Date_Year != "Unknown", Crash_Date_Year != "2011") %>%
  ggplot(aes(Crash_Date_Year, fill=as.factor(Crash_Date_Year))) +
  geom_bar(show.legend = FALSE) +
  geom_text(stat="count", aes(x=Crash_Date_Year, label=..count..), vjust=-0.25) + 
  geom_abline(intercept = 387995/(77/12), slope = 0, lty="dashed") +
  scale_x_continuous(breaks=2015:2021) +
  labs(title = "Frequency of Crashes by Year", 
       x = "Year", 
       y = "Count")
```

This bar plot represents how many drivers were involved in each crash. We can 
see that the majority of crashes involved 2 drivers, which was to be expected 
since two car accidents seem to be the most common. In a distant second was 1 
driver crashes, which again made sense because this encompasses most of the 
other kinds of crashes that are most common. The rest of the crashes had a 
decreasing number of drivers involved in crashes as the number of drivers 
ranged from 3 to 18.

```{r driver, echo=FALSE, message=FALSE}
crashes %>% 
  filter(PersonType == "Driver") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Drivers = n, Frequency = nn) %>%
  mutate(Drivers = reorder(Drivers, Frequency)) %>%
  ggplot(aes(x=Drivers, y=Frequency, fill=Drivers)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.1) +
  coord_flip() +
  labs(title = "Number of Drivers per Crash",
       x = "Number of Drivers",
       y = "Count")
```

This data involved a much larger range of numbers than drivers involved per 
crash. However, despite this fact, we can still follow a pretty regular 
decreasing trend with the majority of crashes involved 1 passenger which 
trickles all the way to a crash involving a maximum of 88 passengers. 

```{r passenger, echo=FALSE, message=FALSE}
crashes %>% 
  filter(PersonType == "Passenger") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Passengers = n, Frequency = nn) %>%
  mutate(Passengers = reorder(Passengers,Frequency)) %>% 
  ggplot(aes(x=Passengers, y=Frequency, fill=Passengers)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Passengers per Crash",
       x = "Number of Passengers",
       y = "Count")
```

There is little variety in the number of pedestrians involved in crashes. When 
pedestrians were involved, there was a majority of it only being 1 with a 
distant second and third being 2 and 3 pedestrians.

```{r pedestrian, echo=FALSE, message=FALSE}
crashes %>% 
  filter(PersonType == "Pedestrian") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>% 
  rename(Pedestrians = n, Frequency = nn) %>%
  mutate(Pedestrians = reorder(Pedestrians,Frequency)) %>% 
  ggplot(aes(x=Pedestrians, y=Frequency, fill=Pedestrians)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Pedestrians per Crash",
       x = "Number of Pedestrians",
       y = "Count")
```

Similar to the number of pedestrians involved in crashes, the number of 
pedalcyclists involved in crashes has little variety and is very low. Compared 
to the total amount of data we are working with, very few crashes involve
pedalcyclists anf if they do, it is only 1 with a singular exception for a 
crash involving 2.

```{r pedalcyclist, echo=FALSE, message=FALSE}
crashes %>% 
  filter(PersonType == "Pedalcyclist") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Pedalcyclists = n, Frequency = nn) %>%
  mutate(Pedalcyclists = reorder(Pedalcyclists,Frequency)) %>% 
  ggplot(aes(x=Pedalcyclists, y=Frequency, fill=Pedalcyclists)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Pedalcyclists per Crash",
       x = "Number of Pedalcyclists",
       y = "Count")
```

Although there is more variety than both number of pedestriand and pedalcyclists 
involved per crash, there is still a very small proportion of other people that 
are involved in crashes. This category encompasses those who do not fit into the categories of driver, passenger, pedestiran, or pedalcyclist. There is a 
majority of 1 other person being involved with a decreasing amount as it goes 
up to a maximum of 5 other people involved. 

```{r other-person, echo=FALSE, message=FALSE}
crashes %>% 
  filter(PersonType == "Other*") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Other = n, Frequency = nn) %>%
  mutate(Other = reorder(Other,Frequency)) %>% 
  ggplot(aes(x=Other, y=Frequency, fill=Other)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Others per Crash",
       x = "Number of Others",
       y = "Count")
```

This data is likely not going to be useful to any of our analyses because it is
fairly likely that the number of unknown people involved in crashes is much 
higher than it realistically was due to poor data entry. This plot included 
many more observations than pedestrians, pedalcyclists, and others combined
with a majority of crashes involving only 1 unknown person and a few involving 2.

```{r unknown-person, echo=FALSE, message=FALSE}
crashes %>% 
  filter(PersonType == "Unknown") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Unknown = n, Frequency = nn) %>%
  mutate(Unknown = reorder(Unknown,Frequency)) %>% 
  ggplot(aes(x=Unknown, y=Frequency, fill=Unknown)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y=0.5) +
  coord_flip() +
  labs(title = "Number of Unknown per Crash",
       x = "Number of Unknown",
       y = "Count")
```

Fortunately, the number of people killed in crashes was low. Therefore, we only 
have a small distribution of number of people killed per crash ranging from 1 
to three with one being the majority and taking a large jump to 2 and 3 killed 
per crash.

```{r killed, echo=FALSE, message=FALSE}
crashes %>% 
  filter(Injury == "Killed") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Killed = n, Frequency = nn) %>%
  mutate(Killed = reorder(Killed, Frequency)) %>%
  ggplot(aes(x=Killed, y=Frequency, fill=Killed)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number Killed per Crash",
       x = "Number Killed",
       y = "Count")
```

There were many more Type A injuries than people killed which represent all of 
the disabling injuries. Once again, we can see a trend of decreasing number of 
type A injuries per crash as the number of those injuries increases with the 
majority if type A injuries per crash is one and the fewest was 5 type A 
injuries per crash with a frequency of only 1.

```{r a-injury, echo=FALSE, message=FALSE}
crashes %>% 
  filter(Injury == "A type injury (disabling)") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(TypeA = n, Frequency = nn) %>%
  mutate(TypeA = reorder(TypeA, Frequency)) %>%
  ggplot(aes(x=TypeA, y=Frequency, fill=TypeA)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Type A Injuries per Crash",
       x = "Number of Type A Injuries",
       y = "Count")
```

Type B injuries represent all of the injuries that occurred that were evident. 
We can see a higher variety in the number of these type of injuries per crash 
as well as more of them total. A majority of the type B injuries per crash is 
one and the frequency decreases as the number of type B injuries per crash 
increases up to 11.

```{r b-injury, echo=FALSE, message=FALSE}
crashes %>% 
  filter(Injury == "B type injury (evident)") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(TypeB = n, Frequency = nn) %>%
  mutate(TypeB = reorder(TypeB, Frequency)) %>%
  ggplot(aes(x=TypeB, y=Frequency, fill=TypeB)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Type B Injuries per Crash",
       x = "Number of Type B Injuries",
       y = "Count")
```

Type C injuries are all of the most minor injuries and, fortunately, is the
injury type that contains the most observations. Following the same trend as 
the other type of injuries, the majority of crashes that involved type C 
injuries only had 1 and there was a decreasing frequency as the number of type 
C injuries per crash increased up to a maximum of 26.

```{r c-injury, echo=FALSE, message=FALSE}
crashes %>% 
  filter(Injury == "C type injury (possible)") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(TypeC = n, Frequency = nn) %>%
  mutate(TypeC = reorder(TypeC, Frequency)) %>%
  ggplot(aes(x=TypeC, y=Frequency, fill=TypeC)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Type C Injuries per Crash",
       x = "Number of Type C Injuries",
       y = "Count")
```

This plot looks similar to the plot that represents the number of passengers 
involved per crash. There is a wide range of possible numbers of uninjured 
people per crash spanning from 1 to 90. Despite this wide range of values, we 
can still see that the data follows the trend of decreasing frequency as the 
number of uninjured people per crash increases. 

```{r no-injury, echo=FALSE, message=FALSE}
crashes %>% 
  filter(Injury == "No injury") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(NoInjury = n, Frequency = nn) %>%
  mutate(NoInjury = reorder(NoInjury, Frequency)) %>%
  ggplot(aes(x=NoInjury, y=Frequency, fill=NoInjury)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of People with No Injuries per Crash",
       x = "Number of People with No Injuries",
       y = "Count")
```

Once again, I do not think that this data will be useful for our analysis since it is likely that these unknown injuries are likely due to poor data entry but we can follow the same trend of a decreasing frequency as the number of unknown injuries per crash in creases from 1 all the way up to 16, with 1 having a very clear majority.

```{r unknown-injury, echo=FALSE, message=FALSE}
crashes %>% 
  filter(Injury == "Unknown") %>%
  group_by(key_crash) %>%
  count() %>% 
  group_by(n) %>%
  count() %>%
  rename(Unknown = n, Frequency = nn) %>%
  mutate(Unknown = reorder(Unknown, Frequency)) %>%
  ggplot(aes(x=Unknown, y=Frequency, fill=Unknown)) +
  geom_bar(stat = "identity", show.legend = FALSE) + 
  geom_text(aes(label=Frequency),nudge_y = 0.5) +
  coord_flip() +
  labs(title = "Number of Unknown Injuries per Crash",
       x = "Number of Unknown Injuries",
       y = "Count")
```

### Bivariate Explorations

```{r contrib-circum-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", ContributingCircumstance1 != "NA", 
         ContributingCircumstance1 != "NaN", 
         ContributingCircumstance1 != "Unable to determine", 
         ContributingCircumstance1 != "Unknown", 
         ContributingCircumstance1 !="") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=ContributingCircumstance1)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Contributing Circumstance",
       x = "Contributing Circumstance",
       y = "Percentage") + 
  scale_x_discrete(labels = c("Alcohol use", 
                              "Going wrong way",
                              "Disregarded other traffic signs",
                              "Disregarded road markings",
                              "Disregarded stop sign",
                              "Disregarded traffic signals",
                              "Disregarded yield sign", 
                              "Driver distracted",
                              "Driver distracted by communication device",
                              "Driver distracted by external distraction", 
                              "Driver distracted by electronic",
                              "Driver distracted by passenger", 
                              "Drug use", 
                              "Exceeded speed limit",
                              "Exceeded safe speed", 
                              "Failed to yield", 
                              "Failure to reduce speed",
                              "Followed too closely",
                              "Improper backing",
                              "Improper lane change", 
                              "Improper or no signal",
                              "Improper parking",
                              "Improper turn",
                              "Inattention",
                              "No contributing circumstance",
                              "Operated defective equipment", 
                              "Erratic, reckless, negligent", 
                              "Other improper passing", 
                              "Other*",
                              "Overcorrected/oversteered",
                              "Passed on curve",  
                              "Passed on hill",
                              "Passed stopped school bus", 
                              "Right turn on red",
                              "Swerved or avoided",  
                              "Use of improper lane",
                              "Visibility obstructed"))
```

Pedestrians are most likely to die, followed by pedalcyclists most likely due to lack of protection and high exposure to the environment. Driver's are slightly less likely to be injured than passengers. 

```{r person-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Injury != "", PersonType != "NA", 
        PersonType != "NaN", PersonType != "Unknown", PersonType != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=PersonType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Person Type",
       x = "Person Type",
       y = "Percentage")
```

Total ejection leads to the most deaths and injuries, followed by partial ejection, and not being ejection leads to the least amount of injury. Ejection most likely leads to more severe injuries due to the car crash being significant enough to lead to ejection as well the injuries that occur from being ejected as well. 

```{r ejection-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Ejection != "NA", 
         Ejection != "NaN", Ejection != "Unknown", Ejection!= "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=Ejection)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Ejection",
       x = "Ejection",
       y = "Percentage")
```

Driveways tend to lead to the least amount of injuries probably due to the slow speed that people are going when in driveways. 

```{r road-feat-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", RoadFeature != "NA", 
         RoadFeature != "NaN", RoadFeature != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=RoadFeature)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Road Feature",
       x = "Road Feature",
       y = "Percentage")
```

Public vehicular areas and private roads/driveways lead to the least amount of injuries. This may be because these areas are minimally trafficked and are usually at slower speeds than other roads. 

```{r road-class-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", RoadClassification != "NA", 
         RoadClassification != "NaN", RoadClassification != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=RoadClassification)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Road Classification",
       x = "Road Classification",
       y = "Percentage")
```

Rain and sleet, hail, freezing rain/drizzle leads to the most disabling type injuries. 

```{r weather-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", WeatherCondition1 != "NA", 
         WeatherCondition1 != "NaN", WeatherCondition1 != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=WeatherCondition1)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Weather Condition",
       x = "Weather Condition",
       y = "Percentage")
```

```{r alcohol-injury, echo=FALSE}
crashes %>%
  filter(AlcoholResultType != "NA", AlcoholResultType != "Unknown", 
         Crash_Date_DOW != "NA", Crash_Date_DOW != "NaN", Crash_Date_DOW != "") %>%
  group_by(AlcoholResultType) %>%
  ggplot(aes(fill=AlcoholResultType, x=Crash_Date_DOW)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Alcohol Result Type Frequency by Crash Date DOW",
       x = "Crash Date DOW",
       y = "Percentage")
```

The most people are killed when there are no alcohol or other drugs. This is slightly surprising, however, it may be because when people are driving with drugs or alcohol in their system, they may attempt to be more cautious so that they do not get pulled over by police. 

```{r alcohol-filter-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", AlcoholResultType != "NA", 
         AlcoholResultType != "NaN", AlcoholResultType != "Unknown",
         AlcoholResultType != "Contaminated sample/unusable", 
         AlcoholResultType != "Pending", AlcoholResultType != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=AlcoholResultType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Alcohol Result Type",
       x = "Alcohol Result Type",
       y = "Percentage")
```

Places where warning signs are post led to the post injuries including people killed. This may be because the signs are not taken as seriously and are less common to see, therefore, more people may disregard the warnings. Not many injuries occur near Railroad crossings. 

```{r traffic-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", TrafficControlType != "NA", 
         TrafficControlType != "NaN", TrafficControlType != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=TrafficControlType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() +
  labs(title = "Injury Frequency by Traffic Control Type",
       x = "Traffic Control Type",
       y = "Percentage")
```

Pedestrian were the most killed, followed by motorcycles and motor scooters. This makes sense because these people are more exposed to conditions as well as generally having less protection than people in enclosed vehicles. Large vehicles like buses, trucks, and military vehicles, had the leaast amount of injuries most likely due to their large size. 

```{r vehicle-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", VehicleType != "NA", 
         VehicleType != "NaN", VehicleType != "Unknown", VehicleType != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=VehicleType)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Vehicle Type",
       x = "Vehicle Type",
       y = "Percentage")
```

The most injuries occurred when people were using reflective clothing, lighting, and a helmet as protection. This makes sense because people using this would most likely be pedestrians or bikers, both of which are more exposed to danger and to having more significant injuries. Shoulder belts, lap belts, and the combination between the two appear to help decrease the amount of injuries that occur. 

```{r protection-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Protection != "NA", 
         Protection != "NaN", Protection != "Unable to determine", 
         Protection != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=Protection)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Protection",
       x = "Protection",
       y = "Percentage")
```

Signs and embankment led to the most people being killed. This may be because these are both stationary opaque objects that will continuously block people's views of the road and conditions. Also being blinded by other lights led to the most disabling injuries. 

```{r vision-obstruct-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", VisionObstruction != "NA", 
         VisionObstruction != "NaN", VisionObstruction != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=VisionObstruction)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequncy by Vision Obstruction",
       x = "Vision Obstruction",
       y = "Percentage")
```

When airbags were not deployed, there was a smaller amount of injuries. This may be because the crashes were not significant enough to cause the airbags to deploy, therefore, if the crash is not significant enough to cause airbags to deploy, the people in the crash were less likely to be harmed. When there were no airbags, there was not many injuries. This may be because cars without airbags tend to be older cars which may mean they cannot go fast enough to lead to an extremely dangerous car crash. When both front and side airbags deploy, there are a significant amount of injuries including disabling injuries. This may be due to the crash being bad enough to deploy the airbags, therefore, if the crash is bad enough, the people are more likely to be injured. 

```{r airbag-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", AirbagDeployed != "NA", 
         AirbagDeployed != "NaN", AirbagDeployed != "Unknown", 
         AirbagDeployed != "") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=AirbagDeployed)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequncy by Airbag Deployed",
       x = "Airbag Deployed",
       y = "Percentage")
```

The first harmful event that led to the second most people killed and disabling injuries was with pedestrians. This would make sense because pedestrians often do not have protection from cars. Overturn/rollover harmful events had the most amount of injuries. Backing up had the least amount of injuries which would make sense because when backing a car up, people tend to be going a slower speed than if they were accelerating forward.

```{r first-harm-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", FirstHarmfulEvent != "NA", 
         FirstHarmfulEvent != "NaN", FirstHarmfulEvent != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=FirstHarmfulEvent)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by First Harmful Event",
       x = "First Harmful Event",
       y = "Percentage")
```

The most harmful event that led to most people killed and disabling injuries was with pedestrians. This would make sense because pedestrians often do not have protection from cars. Overturn/rollover harmful events also had a significant amount of injuries. Backing up had the least amount of injuries which would make sense because when backing a car up, people tend to be going a slower speed than if they were accelerating forward. 

```{r most-harm-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", MostHarmfulEvent != "NA", 
         MostHarmfulEvent != "NaN", MostHarmfulEvent != "Unknown") %>%
  group_by(Injury) %>%
  ggplot(aes(fill=Injury, x=MostHarmfulEvent)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Most Harmful Event",
       x = "Most Harmful Event",
       y = "Percentage")
```

```{r driver-age-injury, echo=FALSE}
# Comparing Injury to Driver Age
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Injury != "", PersonType == "Driver", Age != "NA",
         Age != "", Age != "Unknown", Age >= 5) %>%
  group_by(Injury) %>%
  mutate(shift = case_when(
    Age >= 5 & Age < 15 ~ "5-14",
    Age >= 15 & Age < 25 ~ "15-24",
    Age >= 25 & Age < 35 ~ "25-34",
    Age >= 35 & Age < 45 ~ "35-44",
    Age >= 45 & Age < 55 ~ "45-54",
    Age >= 55 & Age < 65 ~ "55-64",
    Age >= 65 & Age < 75 ~ "65-74",
    Age >= 75 & Age < 85 ~ "75-84",
    Age >= 85 & Age < 95 ~ "85-94",
    Age >= 95 & Age < 105 ~ "95-104",
    Age >= 105 & Age < 115 ~ "105-114",
    TRUE ~ "115-124")) %>%
  ggplot(aes(fill=Injury, x=shift)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Driver Age",
       x = "Age",
       y = "Percentage")
```

```{r driver-age, echo=FALSE}
crashes %>%
  filter(PersonType == "Driver", Age != "NA",
         Age != "", Age != "Unknown", Age >= 5) %>%
  mutate(age = case_when(
    Age >= 5 & Age < 15 ~ "5-14",
    Age >= 15 & Age < 25 ~ "15-24",
    Age >= 25 & Age < 35 ~ "25-34",
    Age >= 35 & Age < 45 ~ "35-44",
    Age >= 45 & Age < 55 ~ "45-54",
    Age >= 55 & Age < 65 ~ "55-64",
    Age >= 65 & Age < 75 ~ "65-74",
    Age >= 75 & Age < 85 ~ "75-84",
    Age >= 85 & Age < 95 ~ "85-94",
    Age >= 95 & Age < 105 ~ "95-104",
    Age >= 105 & Age < 115 ~ "105-114",
    TRUE ~ "115-124")) %>%
  mutate(age = factor(age, levels = c("5-14", "15-24", "25-34", "35-44", "45-54",
                                      "55-64", "65-74", "75-84", "85-94", 
                                      "95-104", "105-114", "115-124"))) %>%
  ggplot(aes(fill=age, x=age)) + 
  geom_bar(show.legend = FALSE) + 
  labs(title = "Frequency of Driver Age",
       x = "Age",
       y = "Count") + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r passenger-age-injury, echo=FALSE}
crashes %>%
  filter(Injury != "NA", Injury != "Unknown", Injury != "", PersonType == "Passenger", Age != "NA",
         Age != "", Age != "Unknown") %>%
  group_by(Injury) %>%
  mutate(shift = case_when(
    Age >= 0 & Age < 10 ~ "0-9",
    Age >= 10 & Age < 20 ~ "10-19",
    Age >= 20 & Age < 30 ~ "20-29",
    Age >= 30 & Age < 40 ~ "30-39",
    Age >= 40 & Age < 50 ~ "40-49",
    Age >= 50 & Age < 60 ~ "50-59",
    Age >= 60 & Age < 70 ~ "60-69",
    Age >= 70 & Age < 80 ~ "70-79",
    Age >= 80 & Age < 90 ~ "80-89",
    Age >= 90 & Age < 100 ~ "90-99",
    Age >= 100 & Age < 110 ~ "100-109",
    Age >= 110 & Age < 120 ~ "110-119",
    TRUE ~ "120-129")) %>%
  ggplot(aes(fill=Injury, x=shift)) + 
  geom_bar(position="fill", stat="count") + 
  coord_flip() + 
  labs(title = "Injury Frequency by Passenger Age",
       x = "Age",
       y = "Percentage")
```

```{r passenger-age, echo=FALSE}
crashes %>%
  filter(PersonType == "Passenger", Age != "NA",
         Age != "", Age != "Unknown") %>%
  mutate(age = case_when(
    Age >= 0 & Age < 10 ~ "0-9",
    Age >= 10 & Age < 20 ~ "10-19",
    Age >= 20 & Age < 30 ~ "20-29",
    Age >= 30 & Age < 40 ~ "30-39",
    Age >= 40 & Age < 50 ~ "40-49",
    Age >= 50 & Age < 60 ~ "50-59",
    Age >= 60 & Age < 70 ~ "60-69",
    Age >= 70 & Age < 80 ~ "70-79",
    Age >= 80 & Age < 90 ~ "80-89",
    Age >= 90 & Age < 100 ~ "90-99",
    Age >= 100 & Age < 110 ~ "100-109",
    Age >= 110 & Age < 120 ~ "110-119",
    TRUE ~ "120-129")) %>%
  mutate(age = factor(age, levels = c("0-9", "10-19", "20-29", "30-39", "40-49", 
                                      "50-59", "60-69", "70-79", "80-89", 
                                      "90-99", "100-109", "110-119",
                                      "120-129"))) %>%
  ggplot(aes(fill=age, x=age)) + 
  geom_bar(show.legend = FALSE) + 
  labs(title = "Frequency of Passenger Age",
       x = "Age",
       y = "Percentage") + 
  theme(axis.text.x = element_text(angle = 90))
```

## Identifying Hot Spots of Crashes in Wake County, North Carolina 

```{r nc-map, echo=FALSE, include=FALSE}
crashes %>% 
  filter(LocationLatitude != "0", LocationLongitude != "0",
         LocationLatitude != "NA", LocationLatitude != "",
         LocationLongitude != "NA", LocationLongitude != "",
         LocationLatitude > 35.4, LocationLatitude < 36.2,
         LocationLongitude < -78, LocationLongitude > -79) %>%
  ggplot(aes(LocationLongitude, LocationLatitude)) +
  borders('county', 'north carolina', fill = "light blue") +
  geom_point(size=0.5, col = 'black', show.legend = F) +
  coord_quickmap() + 
  ggtitle("North Carolina Map of Crash Locations") + 
  xlab("Longitude") + ylab("Latitude")
```

```{r load-library-map, echo=FALSE, message=FALSE}
library(maps)
#install.packages("sf")
library(sf)
```

From the map, we can see that many crashes occur near the center of Wake County. This makes sense because in the center of Wake County sits Raleigh, the capital of North Carolina. 

```{r wake-map, echo=FALSE, include=FALSE}
nc_counties <- map_data("county", "north carolina") %>%
  select(lon = long, lat, group, id = subregion)
head(nc_counties)

wake_county <- nc_counties %>%
  filter(nc_counties$id == "wake")

wake_map <- wake_county %>% 
  ggplot() +
  geom_polygon(aes(lon, lat), color = "darkblue", fill = "lightblue")

crashes_filter <- crashes %>%
  filter(LocationLatitude != "0", LocationLongitude != "0",
         LocationLatitude != "NA", LocationLatitude != "",
         LocationLongitude != "NA", LocationLongitude != "",
         LocationLatitude > 35.4, LocationLatitude < 36.2,
         LocationLongitude < -78, LocationLongitude > -79)

wake_map <- wake_map + 
  geom_point(data = crashes_filter, aes(x=LocationLongitude, y= LocationLatitude), colour = "blue", alpha = 1/10) + 
  ggtitle("Wake County Map of Crashes ") + 
  xlab("Longitude") + ylab("Latitude")

wake_map
```

```{r load-library-interactive-map, message=FALSE, echo=FALSE}
library(ggplot2)
#install.packages("ggmap")
library(ggmap)
library(RColorBrewer)
library(plotly)
```

```{r nc-interactive-map, message=FALSE, warning=FALSE, echo=FALSE}
map_bounds <- c(-78.98, 35.51, -78.24, 36.06)

crashes_filter <- crashes %>%
  filter(LocationLatitude != "0", LocationLongitude != "0",
         LocationLatitude != "NA", LocationLatitude != "",
         LocationLongitude != "NA", LocationLongitude != "",
         LocationLatitude > 35.4, LocationLatitude < 36.2,
         LocationLongitude < -78, LocationLongitude > -79)

coords.map.nc <- get_stamenmap(map_bounds, zoom = 10, maptype = "toner-lite")

coords.map.nc <- ggmap(coords.map.nc, extent="panel", legend="none")
coords.map.nc <- coords.map.nc + stat_density2d(data=crashes_filter,  
                                          aes(x=LocationLongitude, 
                                              y=LocationLatitude, 
                                              fill=..level..),
                                          alpha = 0.3, 
                                          geom="polygon")
coords.map.nc <- coords.map.nc +   scale_fill_gradientn(colours=rev(brewer.pal(7, "RdBu")))

coords.map.nc <- coords.map.nc + theme_bw() + 
  ggtitle("Interactive Heat Map of Crashes in North Carolina (Zoomed-Out)") + 
  xlab("Longitude") + ylab("Latitude")

ggplotly(coords.map.nc) %>%
  highlight(
    "plotly_hover",
    selected = attrs_selected(line = list(color = "black"))
  )
```

From the Wake County heat map, we can see that crashes are much more likely to occur in the center of the city. We see that as more streets populate an area, more crashes occur. 

```{r wake-interactive-map, message=FALSE, warning=FALSE, echo=FALSE}
crashes_filter <- crashes %>%
  filter(LocationLatitude != "0", LocationLongitude != "0",
         LocationLatitude != "NA", LocationLatitude != "",
         LocationLongitude != "NA", LocationLongitude != "",
         LocationLatitude > 35.4, LocationLatitude < 36.2,
         LocationLongitude < -78, LocationLongitude > -79)

map_bounds <- c(-78.8, 35.72, -78.5, 35.9) #coordinates of wake county

coords.map.wake <- get_stamenmap(map_bounds, zoom = 13, maptype = "toner-lite")

coords.map.wake <- ggmap(coords.map.wake, extent="panel")
coords.map.wake <- coords.map.wake + stat_density2d(data=crashes_filter,  
                                          aes(x=LocationLongitude, 
                                              y=LocationLatitude, 
                                              fill=..level..),
                                          alpha=0.3, 
                                          geom="polygon")

coords.map.wake <- coords.map.wake + scale_fill_gradientn(colours=rev(brewer.pal(7, "RdYlGn")))

coords.map.wake <- coords.map.wake + theme_bw() + 
  ggtitle("Heat Map of Crash Locations") + 
  xlab("Latitude") + ylab("Longitude")

ggplotly(coords.map.wake) %>%
  highlight(
    "plotly_hover",
    selected = attrs_selected(line = list(color = "black"))
  )
```

```{r tool, message=FALSE, echo=FALSE}
devtools::install_github("gaospecial/wordcloud2")
```

```{r load-library-word-cloud, message=FALSE, echo=FALSE}
#install.packages('wordcloud2')
library(wordcloud2)
```

From the word cloud, we can see many crashes occur on 440, 40, and Capital Blvd. This makes sense because 440 and 40 are major interstates that connect to several major junctions and Capital Blvd is a main road in North Carolina as well. 

```{r location-on-word-cloud, echo=FALSE}
location_road_name_on_freq <- crashes %>%
  count(LocationRoadNameOn)

set.seed(101)
location_road_name_on_freq %>%
  wordcloud2(shape = 'circle', backgroundColor = "black", minSize = 5) 
```

From the word cloud, we can see that 440, Capital Blvd, 40, and Blue Ridge Rd frequently have crashes that are near by. This would make sense because most of these streets are highly trafficked and populated. 

```{r location-at-word-cloud, echo=FALSE}
location_road_name_at_freq <- crashes %>%
  count(LocationRoadNameAt)

set.seed(102)
location_road_name_at_freq %>%
  wordcloud2(shape = 'circle', backgroundColor = "black", minSize = 5)
```

## Time Series Visualization

From the plot, we see that there are major spikes around March 2015, late October 2015, and December 2016. The two latter spikes may be related to the popular holidays, Halloween and Christmas. 

From the time series plot, we can see that there is a significant drop in car crashes in March 2020. This can be explained by the stay-at-home-orders due to the COVID-19 pandemic. After the stay at home orders, the frequency of crashes seems to be slightly lower throughout May 2021. There will likely be an increase in the next few month due to stay-at-home-orders and COVID-19 regulations being lifted now that the vaccination is available. 

```{r basic-ts, echo=FALSE, warning=FALSE}
crashes_ts = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date) %>%
  summarize(count = length(unique(key_crash)))

crashes_ts %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  ggtitle("Time Series Plot for Frequency of Daily Crashes (With Pandemic Data)") +
  xlab("Date") + ylab("Count") + 
  geom_line() + 
  scale_x_date(date_labels = "%m-%Y", date_breaks = "6 month") + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r annual-ts, echo=FALSE}
crashes_annual = crashes_ts %>%
  separate(Date, 
           into = c("Year", "Month"), sep = 4, remove = FALSE) %>%
  select(-Month)

crashes_annual %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  ggtitle("Time Series Plots for Frequency of Daily Crashes Organized by Year") + 
  geom_line() + 
  scale_x_date(date_labels = "%m-%Y", date_breaks = "1 month") + 
  xlab("Date") + ylab("Count") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year, scales = "free_x")
```

```{r load-library-ts, echo=FALSE, message=FALSE}
library(zoo)
```

```{r 7-day-ma-ts, echo=FALSE, warning=FALSE}
crashes_ts %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  geom_line() +
  geom_line(aes(y=rollmean(count, 7, na.pad = TRUE)), color = "red") +
  scale_x_date(date_labels = "%m-%Y", date_breaks = "6 month") + 
  theme(axis.text.x = element_text(angle = 90), title = element_text(size=8)) + 
  ggtitle("Time Series Plot for Frequency of Daily Crashes With 7 Day Moving Average (With Pandemic Data)")
```

```{r 30-day-ma-ts, echo=FALSE, include=FALSE}
crashes_ts %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  geom_line() +
  geom_line(aes(y=rollmean(count, 30, na.pad = TRUE)), color = "red") +
  scale_x_date(date_labels = "%m-%Y", date_breaks = "6 month") + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("Time Series Plot for Frequency of Daily Crashes With 30 Day Moving Average (With Pandemic Data)")
```

```{r 100-day-ma-ts, echo=FALSE, include=FALSE}
crashes_ts %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  geom_line() +
  geom_line(aes(y=rollmean(count, 100, na.pad = TRUE)), color = "red") +
  scale_x_date(date_labels = "%m-%Y", date_breaks = "6 month") + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("Time Series Plot for Frequency of Daily Crashes with 100 Day Moving Average (with Pandemic Data)")
```

```{r basic-noncovid-ts, echo=FALSE}
crashes_ts.noncovid = crashes %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2020/03/01") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date) %>%
  summarize(count = length(unique(key_crash)))

crashes_ts.noncovid %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  ggtitle("Time Series Plot for Frequency of Daily Crashes (Without Pandemic Data)") + xlab("Date") + ylab("Count") + 
  geom_line() + 
  scale_x_date(date_labels = "%m-%Y", date_breaks = "6 month") + 
  theme(axis.text.x = element_text(angle = 90), title = element_text(size = 11))
```

```{r load-library-forecast, message=FALSE, echo=FALSE}
library(forecast)
library(fpp2)
library(TTR)
```

```{r regression-ts, message=FALSE, echo=FALSE}
#Converting crashes_ts to a time series object 
crashests2 <- ts(crashes_ts$count, start = c(2015,1), end = c(2021,153),
                frequency = 365)

#Converting crashes_ts to a time series object 
crashests <- as.ts(crashes_ts)

#Least squares estimation
fit.crashes <- tslm(count ~ Date, data=crashests)
summary(fit.crashes)

#Fitted values 
autoplot(crashests[,'count'], series="Data") +
  autolayer(fitted(fit.crashes), series="Fitted") +
  xlab("Date") + ylab("Count") +
  ggtitle("Number of Daily Car Crashes (With Pandemic Data)") +
  guides(colour=guide_legend(title=" ")) + 
  scale_x_continuous(breaks = c(0, 181, 365, 547, 731, 912, 1096, 1277, 
                                1461, 1642, 1826, 2008, 2192), 
                     labels = c("01-2015", "07-2015", "01-2016", "07-2016", 
                                "01-2017", "07-2017", "01-2018", "07-2018", 
                                "01-2019", "07-2019", "01-2020", "07-2020", 
                                "01-2021")) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r noncovid-regression-ts, message=FALSE, echo=FALSE}
#Converting crashes_ts to a time series object using ts
crashests.noncovid <- ts(crashes_ts.noncovid$count, start = c(2015,1), 
                         end = c(2020,59), frequency = 365)

#Converting crashes_ts to a time series object using as.ts
crashests.noncovid2 <- as.ts(crashes_ts.noncovid, start = c(2015,1), 
                             end = c(2020,59), frequency = 365)

#Least squares estimation
fit.crashes.noncovid2 <- tslm(count ~ Date, data=crashests.noncovid2)
summary(fit.crashes.noncovid2)

#Fitted values (linear plot through ts)
autoplot(crashests.noncovid2[,'count'], series="Data") +
  autolayer(fitted(fit.crashes.noncovid2), series="Fitted") +
  xlab("Date") + ylab("Count") +
  ggtitle("Number of Daily Car Crashes (Without Pandemic Data)") +
  guides(colour=guide_legend(title=" ")) + 
  scale_x_continuous(breaks = c(0, 181, 365, 547, 731, 912, 1096, 1277, 
                                1461, 1642, 1826), 
                     labels = c("01-2015", "07-2015", "01-2016", "07-2016", 
                                "01-2017", "07-2017", "01-2018", "07-2018", 
                                "01-2019", "07-2019", "01-2020")) + 
  theme(axis.text.x = element_text(angle = 90))
```

### Stationarity Transformations (Daily Data)

```{r stationarity-trans-daily-covid, echo=FALSE}
##Looking at stationarity of crashests2 daily time series 
library(urca)
acf(crashests2)
summary(ur.kpss(crashests2))

ndiffs(crashests2) #1
nsdiffs(crashests2) #0

#Attempt at differencing 
dif_crashests2 <- diff(crashests2)

#Looking at stationarity of first difference 
acf(dif_crashests2)
summary(ur.kpss(dif_crashests2))

ndiffs(dif_crashests2) #0
nsdiffs(dif_crashests2) #0

cbind("Crashes" = crashests2,
      "Logs" = log(crashests2),
      "First differenced" = diff(crashests2),
      "First differenced logs" = diff(log(crashests2))) %>%
  autoplot(facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Crashes")
```

```{r stationarity-trans-daily-noncovid, echo=FALSE}
##Looking at stationarity of crashests.noncovid daily time series 
library(urca)
acf(crashests.noncovid)
summary(ur.kpss(crashests.noncovid))

ndiffs(crashests.noncovid) #1
nsdiffs(crashests.noncovid) #0

#Attempt at differencing (noncovid)
dif_crashests.noncovid <- diff(crashests.noncovid)

#Looking at stationarity of first difference (noncovid)
acf(dif_crashests.noncovid)
summary(ur.kpss(dif_crashests.noncovid))

ndiffs(dif_crashests.noncovid) #0
nsdiffs(dif_crashests.noncovid) #0

cbind("Crashes" = crashests.noncovid,
      "Logs" = log(crashests.noncovid),
      "First differenced" = diff(crashests.noncovid),
      "First differenced logs" = diff(log(crashests.noncovid))) %>%
  autoplot(facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Crashes (Without Pandemic Data)")
```

## Time Series Forecasting

```{r HW-fcast-box-decomp, echo=FALSE, eval=FALSE}
#DONT USE
covid <- HoltWinters(crashests2)

summary(covid)

plot(fitted(covid), main = "Box Jenkins Decomposition of Daily Crashes (With Pandemic Data)")

fcast <- forecast::forecast(covid, h=214, level=c(80,95))
```

```{r rename-HW-fcast-column, echo=FALSE, eval=FALSE}
#DONT USE
daily_forecast_values_covid_HW <- summary(fcast)

rownames(daily_forecast_values_covid_HW) <- seq(as.Date("2021/06/01"), 
                                                as.Date("2021/12/31"), "day")
```

```{r HW_fcast-filter-forecast-ts, echo=FALSE, message=FALSE, eval=FALSE}
#DONT USE 
head(daily_forecast_values_covid_HW)

autoplot(fcast) +
  ggtitle("Forecasts of Daily Car Crashes Using HoltWinters (With Pandemic Data)") +
  xlab("Year") + ylab("Crashes") 
```

```{r STLF-decomp-forecast-ts, echo=FALSE, message=FALSE}
#Nonstationary 
crashests2 %>% mstl() %>%
  autoplot() + 
  ggtitle("Time Series Decomposition (With Non-Stationary Pandemic Data)")

m <- crashests2 %>%
  stlf(lambda = 0, h = 214, level=c(80,95)) 

m %>%
  autoplot() + 
  ggtitle("STLF Model for Daily Car Crashes (With Non-Stationary Pandemic Data)") +
  xlab("Year") + ylab("Crashes") 
```

```{r rename-STLF-fcast, echo=FALSE, include=FALSE}
#Nonstationary
daily_forecast_values_covid_STLF <- summary(m)

rownames(daily_forecast_values_covid_STLF) <- seq(as.Date("2021/06/01"), 
                                                as.Date("2021/12/31"), "day")
```

```{r STLF-fcast-filter, echo=FALSE}
#Nonstationary 
head(daily_forecast_values_covid_STLF)
```

```{r STLF-decomp-forecast-ts-stationary, echo=FALSE, message=FALSE, eval=FALSE}
#Stationary (Doesn't work)
dif_crashests2 %>% mstl() %>%
  autoplot() + 
  ggtitle("Time Series Decomposition (With Stationary Pandemic Data)")

m <- dif_crashests2 %>%
  stlf(lambda = 0, h = 214, level=c(80,95)) 

m %>%
  autoplot() + 
  ggtitle("STLF Model for Daily Car Crashes (With Stationary Pandemic Data)") +
  xlab("Year") + ylab("Crashes") 
```

```{r rename-STLF-fcast-stationary, echo=FALSE, include=FALSE}
#Stationary
daily_forecast_values_covid_STLF <- summary(m)

rownames(daily_forecast_values_covid_STLF) <- seq(as.Date("2021/06/01"), 
                                                as.Date("2021/12/31"), "day")
```

```{r STLF-fcast-filter-stationary, echo=FALSE}
#Stationary
head(daily_forecast_values_covid_STLF)
```

```{r tbats, echo-FALSE, message=FALSE, include=FALSE}
#y <- msts(crashes_ts$count, seasonal.periods=c(7,365.25))
y2 <- msts(crashests2, seasonal.periods=c(7,365.25))

#fit_tbats_covid <- tbats(y)
fit_tbats_covid2 <- tbats(y2)

#fc_tbats_covid <- forecast::forecast(fit_tbats_covid, h=214)
fc_tbats_covid2 <- forecast::forecast(fit_tbats_covid2, h=214)

#daily_forecast_values_covid_TBATS <- summary(fc_tbats_covid)
daily_forecast_values_covid_TBATS2 <- summary(fc_tbats_covid2)

# rownames(daily_forecast_values_covid_TBATS) <- seq(as.Date("2021/06/01"), 
#                                                   as.Date("2021/12/31"), "day")
rownames(daily_forecast_values_covid_TBATS2) <- seq(as.Date("2021/06/01"), 
                                                  as.Date("2021/12/31"), "day")
```

```{r tbats-plot, echo=FALSE, message=FALSE}
#head(daily_forecast_values_covid_TBATS)
head(daily_forecast_values_covid_TBATS2)

# autoplot(fc_tbats_covid) + 
#   ggtitle("TBATS Forecasting Model for Daily Car Crashes (With Pandemic Data)") +
#   xlab("Year") + ylab("Crashes") + 
#   scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
#                      labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
#                                 "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
#   theme(axis.text.x = element_text(angle=90))
autoplot(fc_tbats_covid2) + 
  ggtitle("TBATS Forecasting Model for Daily Car Crashes (With Pandemic Data)") +
  xlab("Year") + ylab("Crashes")
```

```{r HW-noncovid-fcast-decomp, echo=FALSE, eval=FALSE}
#DONT USE
noncovid <- HoltWinters(crashests.noncovid)

summary(noncovid)

plot(fitted(noncovid), main="Box Jenkins Decomposition of Daily Crashes (Without Pandemic Data)", cex.main=1)

fcast.noncovid <- forecast(noncovid, h=671, level=c(80,95))
```

```{r rename-noncovid-HW-fcast, echo=FALSE, eval=FALSE}
#DONT USE
daily_forecast_values_noncovid_HW <- summary(fcast.noncovid)

rownames(daily_forecast_values_noncovid_HW) <- seq(as.Date("2020/03/01"), 
                                                  as.Date("2021/12/31"), "day")
```

```{r noncovid-HW-fcast-filter-forecast-ts, echo=FALSE, eval=FALSE}
#DONT USE
head(daily_forecast_values_noncovid_HW)

true_crashes <- crashes_ts %>%
  filter(Date >= as.Date("2020/03/01") & Date <= as.Date("2021/05/31"))

true_crashes <- ts(true_crashes$count, 
                               start = c(2020,3), end = c(2021,153), 
                               frequency = 365)

autoplot(fcast.noncovid) +
  autolayer(true_crashes, alpha=0.8) + 
  ggtitle("Forecasts of Daily Car Crashes Using HoltWinters (Without Pandemic Data)") +
  xlab("Year") + ylab("Crashes") + 
  theme(legend.position = "bottom")
```

```{r noncovid-STLF-decomp-forecast-ts, echo=FALSE}
crashests.noncovid %>% mstl() %>%
  autoplot() + 
  ggtitle("Time Series Decomposition (Without Pandemic Data)")

p <- crashests.noncovid %>%
  stlf(lambda = 0, h = 671, level = c(80, 95)) 

true_crashes <- crashes_ts %>%
  filter(Date >= as.Date("2020/03/01") & Date <= as.Date("2021/05/31"))

true_crashes <- ts(true_crashes$count, 
                               start = c(2020,3), end = c(2021,153), 
                               frequency = 365)

p %>%
  autoplot() + 
  autolayer(true_crashes, alpha=0.8) + 
  ggtitle("Seasonal and Trend Decomposition Using Loess Forecasting Model for Daily Car Crashes (Without Pandemic Data)") +
  xlab("Year") + ylab("Daily Crashes") + 
  theme(legend.position = "bottom")
```

```{r rename-noncovid-STLF-fcast, echo=FALSE, include=FALSE}
daily_forecast_values_noncovid_STLF <- summary(p)

rownames(daily_forecast_values_noncovid_STLF) <- seq(as.Date("2020/03/01"), 
                                                   as.Date("2021/12/31"), "day")
```

```{r noncovid-STLF-fcast-filter, echo=FALSE}
head(daily_forecast_values_noncovid_STLF)
```

```{r tbats-noncovid, echo=FALSE, message=FALSE, include=FALSE}
#y.noncovid <- msts(crashes_ts.noncovid$count, seasonal.periods=c(7,365.25))
y2.noncovid <- msts(crashests.noncovid, seasonal.periods=c(7,365.25))

#fit_tbats_noncovid <- tbats(y.noncovid)
fit_tbats_noncovid2 <- tbats(y2.noncovid)

# fc_tbats_noncovid <- forecast::forecast(fit_tbats_noncovid, h=671)
fc_tbats_noncovid2 <- forecast::forecast(fit_tbats_noncovid2, h=671)

# daily_forecast_values_noncovid_TBATS <- summary(fc_tbats_noncovid)
daily_forecast_values_noncovid_TBATS2 <- summary(fc_tbats_noncovid2)

# rownames(daily_forecast_values_noncovid_TBATS) <- seq(as.Date("2020/03/01"), 
#                                                       as.Date("2021/12/31"), "day")
rownames(daily_forecast_values_noncovid_TBATS2) <- seq(as.Date("2020/03/01"), 
                                                       as.Date("2021/12/31"), "day")
```

```{r tbats-noncovid-plot, echo=FALSE, message=FALSE}
# head(daily_forecast_values_noncovid_TBATS)
head(daily_forecast_values_noncovid_TBATS2)

# true_noncovid_crashes <- crashes_ts %>%
#   filter(Date >= as.Date("2020/03/01") & Date <= as.Date("2021/05/31"))

true_noncovid_crashes <- ts(true_noncovid_crashes$count, 
                            start = c(2020,3), end = c(2021,153), 
                            frequency = 365)

# autoplot(fc_tbats_noncovid) + 
#   #autolayer(true_noncovid_crashes, alpha=0.8) + 
#   ggtitle("TBATS Forecasting Model for Daily Car Crashes (Without Pandemic Data)") +
#   xlab("Year") + ylab("Crashes") + 
#   scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
#                      labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
#                                 "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
#   theme(axis.text.x = element_text(angle=90), legend.position = "bottom")
autoplot(fc_tbats_noncovid2) + 
  autolayer(true_noncovid_crashes, alpha=0.8) + 
  ggtitle("TBATS Forecasting Model for Daily Car Crashes (Without Pandemic Data)") +
  xlab("Year") + ylab("Crashes") + 
  theme(legend.position = "bottom")
```

```{r ms-HW-forecast-ts, echo=FALSE, message=FALSE, include=FALSE}
training_HW <- subset(crashests2, end=length(crashests2)-151)
test_HW <- subset(crashests2, start=length(crashests2)-150)
crashes.train_HW <- HoltWinters(training_HW)
crashes.train_HW %>%
  forecast::forecast(h=151, level=c(80,95)) %>%
  autoplot(alpha=0.2) + 
  autolayer(test_HW, alpha=0.75) + 
  theme(legend.position = "bottom") + 
  ggtitle("Multi-Step HoltWinters Forecasts of Crashes (With Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r rename-ms-HW-fcast, echo=FALSE, include=FALSE}
fcast.ms.HW.daily.covid <- summary(forecast::forecast(crashes.train_HW, h=152, level=c(80,95)))

rownames(fcast.ms.HW.daily.covid) <- seq(as.Date("2021/01/01"), 
                                                   as.Date("2021/06/01"), "day")
```

```{r ms-HW-fcast-filter-decomp-sum, echo=FALSE, message=FALSE, include=FALSE}
head(fcast.ms.HW.daily.covid)

autoplot(training_HW, series="Training data") +
  autolayer(fitted(crashes.train_HW, h=12),
            series="12-step fitted values") + 
  theme(legend.position = "bottom") + 
  ggtitle("Jenkins Box Decomposition of Crashes (With Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r ms-STLF-forecast-ts, echo=FALSE}
training_STLF <- subset(crashests2, end=length(crashests2)-152)
test_STLF <- subset(crashests2, start=length(crashests2)-151)
crashes.train_STLF <- stlf(training_STLF, lambda = 0, h = 152, level=c(80,95))
crashes.train_STLF %>%
  forecast::forecast(h=152) %>%
  autoplot(alpha=0.2) + 
  autolayer(test_STLF, alpha = 0.75) + 
  theme(legend.position = "bottom") + 
  ggtitle("Multi-Step STLF Forecasts of Crashes (With Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r rename-ms-STLF-fcast, echo=FALSE, include=FALSE}
fcast.ms.STLF.daily.covid <- summary(crashes.train_STLF)

rownames(fcast.ms.STLF.daily.covid) <- seq(as.Date("2021/01/01"), 
                                         as.Date("2021/06/01"), "day")
```

```{r ms-STLF-fcast-filter-decomp-sum, echo=FALSE, message=FALSE}
head(fcast.ms.STLF.daily.covid)

autoplot(training_STLF, series="Training data") +
  autolayer(fitted(crashes.train_STLF, h=12),
            series="12-step fitted values") + 
  theme(legend.position = "bottom") + 
  ggtitle("12-Step Fitted Values STLF Model") + 
  xlab("Date") + ylab("Crashes")
```

```{r tbats-ms, echo=FALSE, message=FALSE}
# y <- msts(crashes_ts$count, seasonal.periods=c(7,365.25))
y2 <- msts(crashests2, seasonal.periods=c(7,365.25))

# training_TBATS <- subset(y, end=length(y)-151)
training_TBATS2 <- subset(y2, end=length(y2)-151)

# test_TBATS <- subset(y, start=length(y)-150)
test_TBATS2 <- subset(y2, start=length(y2)-150)

# crashes.train_TBATS <- tbats(training_TBATS)
crashes.train_TBATS2 <- tbats(training_TBATS2)

# crashes.train_TBATS %>%
#   forecast(h=151) %>%
#   autoplot(alpha=0.2) + 
#   autolayer(test_TBATS, alpha=0.75) + 
#   scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
#                      labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
#                                 "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
#   theme(axis.text.x = element_text(angle=90), legend.position = "bottom") + 
#   ggtitle("Multi-Step TBATS Daily Forecasts of Crashes (With Pandemic Data)") + 
#   xlab("Date") + ylab("Crashes") 
crashes.train_TBATS2 %>%
  forecast(h=151) %>%
  autoplot(alpha=0.2) + 
  ggtitle("Multi-Step TBATS Daily Forecasts of Crashes (With Pandemic Data)") + 
  xlab("Date") + ylab("Crashes") + 
  autolayer(test_TBATS2, alpha=0.75) + 
  theme(legend.position = "bottom")
```

```{r tbats-ms-fcast-covid, echo=FALSE, message=FALSE, include=FALSE}
# fcast.ms.TBATS.covid <- summary(forecast::forecast(crashes.train_TBATS, h=152, level=c(80,95)))
# 
# rownames(fcast.ms.TBATS.covid) <- seq(as.Date("2021/01/01"), as.Date("2021/06/01"), "day")

fcast.ms.TBATS.covid2 <- summary(forecast::forecast(crashes.train_TBATS2, h=152, level=c(80,95)))

rownames(fcast.ms.TBATS.covid2) <- seq(as.Date("2021/01/01"), as.Date("2021/06/01"), "day")
```

```{r tbats-ms-plot, echo=FALSE, message=FALSE, warning=FALSE}
# head(fcast.ms.TBATS.covid)
head(fcast.ms.TBATS.covid2)

# autoplot(training_TBATS, series="Training data") +
#   autolayer(fitted(crashes.train_TBATS, h=12),
#             series="12-step fitted values") + 
#   ggtitle("12-Step Fitted Values of TBATS Model (With Pandemic Data)") + 
#   xlab("Date") + ylab("Crashes")
autoplot(training_TBATS2, series="Training data") +
  autolayer(fitted(crashes.train_TBATS2, h=12),
            series="12-step fitted values") + 
  ggtitle("12-Step Fitted Values of TBATS Model (With Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")

# crashes.test_TBATS <- tbats(test_TBATS)
crashes.test_TBATS2 <- tbats(test_TBATS2)

# accuracy(crashes.test_TBATS)
accuracy(crashes.test_TBATS2)
```

```{r combination, echo=FALSE, message=FALSE}
#reload libraries 
library(forecast)
library(TTR)
library(fpp2)

train <- window(crashests2, end=c(2019,12))
h <- length(crashests2) - length(train)
#ETS <- forecast(ets(train), h=h)
ARIMA <- forecast::forecast(auto.arima(train, lambda=0, biasadj=TRUE), h=h)
STL <- stlf(train, lambda=0, h=h, biasadj=TRUE)
NNAR <- forecast::forecast(nnetar(train), h=h)
TBATS <- forecast::forecast(tbats(train, biasadj=TRUE), h=h)

Combination <- (ARIMA[["mean"]] + TBATS[["mean"]] + STL[["mean"]] + 
                  NNAR[["mean"]])/4

true_noncovid_crashes <- crashes_ts %>%
  filter(Date >= as.Date("2019/01/01") & Date <= as.Date("2021/05/31"))

true_noncovid_crashes <- ts(true_noncovid_crashes$count, 
                            start = c(2019,1), end = c(2021,153), 
                            frequency = 365)

library(RColorBrewer)

autoplot(train) +
  autolayer(true_noncovid_crashes) +
  autolayer(NNAR, series="NNAR", alpha=0.8) +
  autolayer(STL, series="STL", PI=F, alpha=0.8) +
  autolayer(Combination, series="Combination", alpha=0.8) +
  autolayer(ARIMA, series="ARIMA", PI=F) +
  autolayer(TBATS, series="TBATS", PI=F) +
  scale_color_brewer(palette="RdYlBu") + 
  xlab("Year") + ylab("Crashes") +
  ggtitle("Time Series Combination (With Pandemic Data)")

c(ARIMA = accuracy(ARIMA, crashests2)["Test set", "RMSE"],
  TBATS = accuracy(TBATS, crashests2)["Test set", "RMSE"],
  NNAR = accuracy(NNAR, crashests2)["Test set", "RMSE"],
  STL = accuracy(STL, crashests2)["Test set", "RMSE"],
  Combination =
    accuracy(Combination, crashests2)["Test set", "RMSE"])
```

```{r combination-statistics, echo=FALSE}
c(ARIMA = accuracy(ARIMA, crashests2)["Test set", "RMSE"],
  TBATS = accuracy(TBATS, crashests2)["Test set", "RMSE"],
  NNAR = accuracy(NNAR, crashests2)["Test set", "RMSE"],
  STL = accuracy(STL, crashests2)["Test set", "RMSE"],
  Combination =
    accuracy(Combination, crashests2)["Test set", "RMSE"])
```

```{r noncovid-combination, echo=FALSE, message=FALSE, warning = FALSE}
train.noncovid <- window(crashests2, end=c(2019,12))
h.noncovid <- 426
ARIMA.noncovid <- forecast::forecast(auto.arima(train.noncovid, lambda=0, 
                                                biasadj=TRUE), h=h.noncovid)
STL.noncovid <- stlf(train.noncovid, lambda=0, h=h.noncovid, biasadj=TRUE)
NNAR.noncovid <- forecast::forecast(nnetar(train.noncovid), h=h.noncovid)
TBATS.noncovid <- forecast::forecast(tbats(train.noncovid, biasadj=TRUE), 
                                     h=h.noncovid)

Combination.noncovid <- (ARIMA.noncovid[["mean"]] + TBATS.noncovid[["mean"]] + STL.noncovid[["mean"]] + NNAR.noncovid[["mean"]])/4

true_noncovid_crashes <- crashes_ts %>%
  filter(Date >= as.Date("2019/01/01") & Date <= as.Date("2020/03/01"))

true_noncovid_crashes <- ts(true_noncovid_crashes$count, 
                            start = c(2019,1), end = c(2020,60), 
                            frequency = 365)

autoplot(train.noncovid) +
  autolayer(true_noncovid_crashes) +
  autolayer(NNAR.noncovid, series="NNAR", alpha=0.8) +
  autolayer(STL.noncovid, series="STL", PI=F, alpha=0.8) +
  autolayer(Combination.noncovid, series="Combination", alpha=0.8) +
  autolayer(ARIMA.noncovid, series="ARIMA", PI=F) +
  autolayer(TBATS.noncovid, series="TBATS", PI=F) +
  scale_color_brewer(palette="RdYlBu") + 
  xlab("Year") + ylab("Crashes") +
  ggtitle("Time Series Combination (Without Pandemic Data)") + 
  theme(legend.position = "bottom")

c(ARIMA = accuracy(ARIMA.noncovid, crashests2)["Test set", "RMSE"],
  TBATS = accuracy(TBATS.noncovid, crashests2)["Test set", "RMSE"],
  NNAR = accuracy(NNAR.noncovid, crashests2)["Test set", "RMSE"],
  STL = accuracy(STL.noncovid, crashests2)["Test set", "RMSE"],
  Combination =
    accuracy(Combination.noncovid, crashests2)["Test set", "RMSE"])
```

```{r noncovid-ms-HW-forecast-ts, echo=FALSE, message=FALSE, include=FALSE}
training_HW_noncovid <- subset(crashests.noncovid , end=length(crashests.noncovid)-426)
test_HW_noncovid <- subset(crashests.noncovid, start=length(crashests.noncovid)-425)
crashes.train_HW_noncovid <- HoltWinters(training_HW_noncovid)
crashes.train_HW_noncovid %>%
  forecast::forecast(h=426, level=c(80,95)) %>%
  autoplot(alpha=0.2) + 
  autolayer(test_HW_noncovid, alpha=0.75) + 
  theme(legend.position = "bottom") + 
  ggtitle("Multi-Step HoltWinters Forecasts of Crashes (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r rename-noncovid-ms-HW-fcast, echo=FALSE, include=FALSE}
fcast.ms.HW.daily.noncovid <- summary(forecast::forecast(crashes.train_HW_noncovid, h=426, level=c(80,95)))

rownames(fcast.ms.HW.daily.noncovid) <- seq(as.Date("2019/01/01"), 
                                         as.Date("2020/03/01"), "day")
```

```{r noncovid-ms-HW-fcast-filter-decomp-sum, echo=FALSE, message=FALSE, include=FALSE}
head(fcast.ms.HW.daily.noncovid)

autoplot(training_HW_noncovid, series="Training data") +
  autolayer(fitted(crashes.train_HW_noncovid, h=12),
            series="12-step fitted values") + 
  theme(legend.position = "bottom") + 
  ggtitle("Jenkins Decomposition") + 
  xlab("Date") + ylab("Crashes")
```

```{r noncovid-ms-STLF-forecast-ts2, echo=FALSE}
training_STLF_noncovid <- subset(crashests.noncovid, end=length(crashests.noncovid)-426)
test_STLF_noncovid <- subset(crashests.noncovid, start=length(crashests.noncovid)-425)
crashes.train_STLF_noncovid <- stlf(training_STLF_noncovid, lambda = 0, h = 426, level=c(80,95))
crashes.train_STLF_noncovid %>%
  forecast(h=426) %>%
  autoplot(alpha=0.2) + 
  autolayer(test_STLF_noncovid, alpha = 0.75) + 
  theme(legend.position = "bottom") + 
  ggtitle("Multi-Step STLF Forecasts of Crashes (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r rename-noncovid-ms-stlf-fcast, echo=FALSE, include=FALSE}
fcast.ms.STLF.daily.noncovid <- summary(crashes.train_STLF_noncovid)

rownames(fcast.ms.STLF.daily.noncovid) <- seq(as.Date("2019/01/01"), 
                                         as.Date("2020/03/01"), "day")
```

```{r noncovid-ms-stlf-fcast-filter-decomp-sum2, echo=FALSE, warning=FALSE}
head(fcast.ms.STLF.daily.noncovid)

autoplot(training_STLF_noncovid, series="Training data") +
  autolayer(fitted(crashes.train_STLF_noncovid, h=12),
            series="12-step fitted values") + 
  theme(legend.position = "bottom") + 
  ggtitle("12-Step Fitted Values STLF Model") + 
  xlab("Date") + ylab("Crashes")
```

```{r tbats-ms-noncovid, echo=FALSE, message=FALSE, include=FALSE}
# y.noncovid <- msts(crashes_ts.noncovid$count, seasonal.periods=c(7,365.25))
y2.noncovid <- msts(crashests.noncovid, seasonal.periods=c(7,365.25))

# training_TBATS.noncovid <- subset(y.noncovid, end=length(y.noncovid)-426)
training_TBATS2.noncovid <- subset(y2.noncovid, end=length(y2.noncovid)-426)

# test_TBATS.noncovid <- subset(y.noncovid, start=length(y.noncovid)-425)
test_TBATS2.noncovid <- subset(y2.noncovid, start=length(y2.noncovid)-425)

# crashes.train_TBATS.noncovid <- tbats(training_TBATS.noncovid)
crashes.train_TBATS2.noncovid <- tbats(training_TBATS2.noncovid)

# fcast.ms.TBATS.noncovid <- summary(crashes.train_TBATS.noncovid%>%forecast::forecast(h=426))

fcast.ms.TBATS.noncovid2 <- summary(crashes.train_TBATS2.noncovid%>%forecast::forecast(h=426))

# rownames(fcast.ms.TBATS.noncovid) <- seq(as.Date("2019/01/01"), 
#                                          as.Date("2020/03/01"), "day")

rownames(fcast.ms.TBATS.noncovid2) <- seq(as.Date("2019/01/01"), 
                                         as.Date("2020/03/01"), "day")
```

```{r tbats-noncovid-plots, echo=FALSE, message=FALSE, warning=FALSE}
# head(fcast.ms.TBATS.noncovid)
head(fcast.ms.TBATS.noncovid2)

# crashes.train_TBATS.noncovid %>%
#   forecast(h=426) %>%
#   autoplot(alpha=0.2) + 
#   autolayer(test_TBATS.noncovid, alpha=0.75, series="test_TBATS") +
#   theme(legend.position = "bottom") + 
#   scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
#                      labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
#                                 "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
#   theme(axis.text.x = element_text(angle=90), legend.position = "bottom") + 
#   ggtitle("Multi-Step TBATS Daily Forecasts of Crashes (Without Pandemic Data)") + 
#   xlab("Date") + ylab("Crashes") 
crashes.train_TBATS2.noncovid %>%
  forecast(h=426) %>%
  autoplot(alpha=0.2) + 
  ggtitle("Multi-Step TBATS Daily Forecasts of Crashes (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes") + 
  autolayer(test_TBATS2.noncovid, alpha=0.75, series="test_TBATS") + 
  theme(legend.position = "bottom")

# autoplot(training_TBATS.noncovid, series="Training data") +
#   autolayer(fitted(crashes.train_TBATS.noncovid, h=12),
#             series="12-step fitted values") + 
#   ggtitle("12-Step Fitted Values of TBATS Model (Without Pandemic Data)") + 
#   xlab("Date") + ylab("Crashes")
autoplot(training_TBATS2.noncovid, series="Training data") +
  autolayer(fitted(crashes.train_TBATS2.noncovid, h=12),
            series="12-step fitted values") + 
  ggtitle("12-Step Fitted Values of TBATS Model (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")

# crashes.test_TBATS.noncovid <- tbats(test_TBATS.noncovid)
crashes.test_TBATS2.noncovid <- tbats(test_TBATS2.noncovid)

# accuracy(crashes.test_TBATS.noncovid)
accuracy(crashes.test_TBATS2.noncovid)
```

```{r monthly-ts, message=FALSE, echo=FALSE}
crashes_mts = crashes %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2021/05/31") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date) %>%
  summarize(count = length(unique(key_crash))) %>%
  separate(Date, into = c("Year", "Month", "Day"), sep = "/") %>%
  group_by(Year, Month) %>%
  summarise(mcount = sum(count)) %>%
  tidyr::spread(key=Month, value=mcount)

crashes_mts = as.data.frame(crashes_mts)

rownames(crashes_mts) = seq(2015, 2021)

crashes_mts3 = crashes_mts %>%
  select(02:13)

crashes_mts2 <- ts(c(t(crashes_mts3)), frequency=12)

crashes_mts4 <- window(crashes_mts2, start=c(1,01), end=c(7,05), frequency=12)

fit.crashes <- tslm(crashes_mts4 ~ trend + season)

summary(fit.crashes)

fcast <- forecast::forecast(fit.crashes, h=8, level=c(80,95))
```

```{r rename-monthly-lin-fcast, echo=FALSE, include=FALSE}
monthly_forecast_values_covid_lin <- summary(fcast)

rownames(monthly_forecast_values_covid_lin) <- seq(as.Date("2021/06/01"), 
                                                     as.Date("2022/01/01"), 
                                                   "month")
```

```{r monthly-lin-fcast-filter-forecast-ts, echo=FALSE, message=FALSE}
monthly_forecast_values_covid_lin

autoplot(fcast) +
  ggtitle("Forecasts of Monthly Car Crashes Using Linear Model (With Pandemic Data)") + xlab("Year") + ylab("Monthly Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r monthly-noncovid-ts, message=FALSE, echo=FALSE}
crashes_mts.noncovid = crashes %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2020/02/29") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date) %>%
  summarize(count = length(unique(key_crash))) %>%
  separate(Date, into = c("Year", "Month", "Day"), sep = "/") %>%
  group_by(Year, Month) %>%
  summarise(mcount = sum(count)) %>%
  tidyr::spread(key=Month, value=mcount)

crashes_mts.noncovid = as.data.frame(crashes_mts.noncovid)

rownames(crashes_mts.noncovid) = seq(2015, 2020)

crashes_mts3.noncovid = crashes_mts.noncovid %>%
  select(02:13)

crashes_mts2.noncovid <- ts(c(t(crashes_mts3.noncovid)), frequency=12)

crashes_mts4.noncovid <- window(crashes_mts2.noncovid, start=c(1,01), 
                                end=c(6,02), frequency=12)
fit.crashes.noncovid <- tslm(crashes_mts4.noncovid ~ trend + season)

summary(fit.crashes.noncovid)

fcast.noncovid <- forecast::forecast(fit.crashes.noncovid, h=23, level=c(80,95))
```

```{r rename-noncovid-monthly-fcast, echo=FALSE, include=FALSE}
monthly_forecast_values_noncovid_lin <- summary(fcast.noncovid)

rownames(monthly_forecast_values_noncovid_lin) <- seq(as.Date("2020/03/01"), 
                                                   as.Date("2022/01/01"),
                                                   "month")
```

```{r noncovid-monthly-lin-fcast-filter-forecast-ts, echo=FALSE, message=FALSE}
head(monthly_forecast_values_noncovid_lin)

autoplot(fcast.noncovid) +
  ggtitle("Forecasts of Monthly Car Crashes Using Linear Model (Without Pandemic Data)") +
  xlab("Year") + ylab("Monthly Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7, 8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", 
                                "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", 
                                "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90), title = element_text(size = 10))
```

### Stationarity Transformations (Monthly Data)

```{r stationarity-trans-monthly-covid, echo=FALSE}
##Looking at stationarity of crashes_mts4 monthly time series 
library(urca)
acf(crashes_mts4)
summary(ur.kpss(crashes_mts4))

ndiffs(crashes_mts4) #1
nsdiffs(crashes_mts4) #0

#Attempt at differencing 
dif_crashes_mts4 <- diff(crashes_mts4)

#Looking at stationarity of first difference 
acf(dif_crashes_mts4)
summary(ur.kpss(dif_crashes_mts4))

ndiffs(dif_crashes_mts4) #0
nsdiffs(dif_crashes_mts4) #0

cbind("Crashes" = crashes_mts4,
      "First differenced" = diff(crashes_mts4)) %>%
  autoplot(facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Crashes")
```

```{r stationarity-trans-monthly-noncovid, echo=FALSE}
##Looking at stationarity of crashes_mts4.noncovid monthly time series 
library(urca)
acf(crashes_mts4.noncovid)
summary(ur.kpss(crashes_mts4.noncovid))

ndiffs(crashes_mts4.noncovid) #1
nsdiffs(crashes_mts4.noncovid) #1

#Attempt at seasonal differencing (noncovid)
season_dif_crashes_mts4.noncovid <- diff(crashes_mts4.noncovid,12)

#Looking at stationarity of seasonal difference (noncovid)
acf(season_dif_crashes_mts4.noncovid)
summary(ur.kpss(season_dif_crashes_mts4.noncovid))

ndiffs(season_dif_crashes_mts4.noncovid) #0
nsdiffs(season_dif_crashes_mts4.noncovid) #0

cbind("Crashes" = crashes_mts4.noncovid,
      "Seasonally\n differenced" = diff(crashes_mts4.noncovid, 12)) %>%
  autoplot(facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Crashes (Without Pandemic Data)")
```

```{r monthly-HW-fcast-decomp, echo=FALSE}
covid.monthly <- HoltWinters(crashes_mts4)

summary(covid.monthly)

plot(fitted(covid.monthly), main = "Box Jenkins Decomposition of Monthly Crashes (With Pandemic Data)", cex.main=1)

fcast.covid.monthly <- forecast::forecast(covid.monthly, h=8, level=c(80,95))
```

```{r rename-monthly-HW-fcast, echo=FALSE, include=FALSE}
monthly_forecast_values_covid_HW <- summary(fcast.covid.monthly)

rownames(monthly_forecast_values_covid_HW) <- seq(as.Date("2021/06/01"), 
                                                      as.Date("2022/01/01"), 
                                                  "month")
```

```{r monthly-HW-fcast-filter-forecast-ts, echo=FALSE, message=FALSE}
monthly_forecast_values_covid_HW

autoplot(fcast.covid.monthly) +
  ggtitle("Forecasts of Monthly Car Crashes Using HoltWinters (With Pandemic Data)") +
  xlab("Year") + ylab("Crashes") +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7, 8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r noncovid-monthly-HW-fcast-decomp, echo=FALSE}
noncovid.monthly <- HoltWinters(crashes_mts4.noncovid)

summary(noncovid.monthly)

plot(fitted(noncovid.monthly), main = "Box Jenkins Decomposition of Monthly Crashes (Without Pandemic Data)", cex.main=1)

fcast.noncovid.monthly <- forecast::forecast(noncovid.monthly, h=23, level=c(80,95))
```

```{r rename-noncovid-monthly-HW-fcast, echo=FALSE, include=FALSE}
monthly_forecast_values_noncovid_HW <- summary(fcast.noncovid.monthly)

rownames(monthly_forecast_values_noncovid_HW) <- seq(as.Date("2020/03/01"), 
                                                      as.Date("2022/01/01"), 
                                                     "month")
```

```{r noncovid-monthly-fcast-filter-forecast-ts, echo=FALSE, message=FALSE}
head(monthly_forecast_values_noncovid_HW)

autoplot(fcast.noncovid.monthly) +
  ggtitle("Forecasts of Monthly Car Crashes Using HoltWinters (Without Pandemic Data)") +
  xlab("Year") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7, 8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90), title = element_text(size = 10))
```

```{r monthly-STLF-forecast-ts-decomp, echo=FALSE, message=FALSE}
crashes_mts4 %>% mstl() %>%
  autoplot() + 
  ggtitle("Box Jenkins Decomposition") + 
  xlab("Date") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90))

t <- crashes_mts4 %>%
  stlf(lambda = 0, h = 8, level=c(80,95)) 

t %>%
  autoplot() + 
  ggtitle("SLTF Model for Monthly Car Crashes (With Pandemic Data)") +
  xlab("Year") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r rename-monthly-STLF-fcast, echo=FALSE, include=FALSE}
monthly_forecast_values_covid_STLF <- summary(t)

rownames(monthly_forecast_values_covid_STLF) <- seq(as.Date("2021/06/01"), 
                                                     as.Date("2022/01/01"), "month")
```

```{r monthly-STLF-fcast-filter, echo=FALSE}
monthly_forecast_values_covid_STLF
```

```{r noncovid-monthly-STLF-forecast-ts-decomp, echo=FALSE, message=FALSE}
crashes_mts4.noncovid %>% mstl() %>%
  autoplot() + 
  ggtitle("Box Jenkins Decomposition") + 
  xlab("Date") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90))

q <- crashes_mts4.noncovid %>%
  stlf(lambda = 0, h = 23, level=c(80,95)) 

q %>%
  autoplot() + 
  ggtitle("STLF Model for Monthly Car Crashes (Without Pandemic Data)") +
  xlab("Year") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r rename-noncovid-monthly-STLF-fcast, echo=FALSE, include=FALSE}
monthly_forecast_values_noncovid_STLF <- summary(q)

rownames(monthly_forecast_values_noncovid_STLF) <- seq(as.Date("2020/03/01"), 
                                                     as.Date("2022/01/01"), "month")
```

```{r noncovid-monthly-STLF-fcast-filter, echo=FALSE}
head(monthly_forecast_values_noncovid_STLF)
```

```{r ms-HW-monthly-forecast-ts, echo=FALSE,message=FALSE}
training_HW_monthly <- subset(crashes_mts4, end=length(crashes_mts4)-5)

test_HW_monthly <- subset(crashes_mts4, start=length(crashes_mts4)-4)

crashes.train_HW_monthly <- HoltWinters(training_HW_monthly)

crashes.train_HW_monthly %>%
  forecast::forecast(h=5, level=c(80,95)) %>%
  autoplot() + autolayer(test_HW_monthly) + 
  ggtitle("Multi-Step HoltWinters Monthly Forecasts of Crashes (Pandemic)") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r rename-ms-HW-monthly-fcast, echo=FALSE, include=FALSE}
fcast.ms.HW.monthly.covid <- summary(forecast::forecast(crashes.train_HW_monthly, h=5, level=c(80,95)))

rownames(fcast.ms.HW.monthly.covid) <- seq(as.Date("2021/01/01"),
                                           as.Date("2021/05/01"), "month")
```

```{r ms-HW-monthly-fcast-filter-decomp-sum, echo=FALSE, message=FALSE}
fcast.ms.HW.monthly.covid

autoplot(training_HW_monthly, series="Training data") +
  autolayer(fitted(crashes.train_HW_monthly, h=12),
            series="12-step fitted values") + 
  theme(legend.position = "bottom") + 
  ggtitle("Box Decomposition") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r ms-STLF-monthly-forecast-ts, echo=FALSE, message=FALSE}
training_STLF_monthly <- subset(crashes_mts4, end=length(crashes_mts4)-5)

test_STLF_monthly <- subset(crashes_mts4, start=length(crashes_mts4)-4)

crashes.train_STLF_monthly <- stlf(training_STLF_monthly, lambda = 0, h = 5, level=c(80,95))

crashes.train_STLF_monthly %>%
  forecast::forecast(h=5) %>%
  autoplot() + autolayer(test_STLF_monthly) + 
  ggtitle("Multi-Step STLF Monthly Forecasts of Crashes (With Pandemic Data)") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r rename-ms-STLF-monthly-fcast, echo=FALSE, include=FALSE}
fcast.ms.STLF.monthly.covid <- summary(crashes.train_STLF_monthly)

rownames(fcast.ms.STLF.monthly.covid) <- seq(as.Date("2021/01/01"),
                                           as.Date("2021/05/01"), "month")
```

```{r ms-STLF-monthly-fcast-filter-decomp-sum, echo=FALSE, message=FALSE}
fcast.ms.STLF.monthly.covid

autoplot(training_STLF_monthly, series="Training data") +
  autolayer(fitted(crashes.train_STLF_monthly, h=12),
            series="12-step fitted values") + 
  theme(legend.position = "bottom") + 
  ggtitle("12-Step Fitted Values") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r noncovid-ms-HW-monthly-forecast-ts, echo=FALSE, message=FALSE}
training_HW_noncovid_monthly <- subset(crashes_mts4.noncovid, 
                                       end=length(crashes_mts4.noncovid)-14)

test_HW_noncovid_monthly <- subset(crashes_mts4.noncovid, 
                                   start=length(crashes_mts4.noncovid)-13)

crashes.train_HW_noncovid_monthly <- HoltWinters(training_HW_noncovid_monthly)

crashes.train_HW_noncovid_monthly %>%
  forecast::forecast(h=14, level=c(80,95)) %>%
  autoplot() + autolayer(test_HW_noncovid_monthly) + 
  ggtitle("Multi-Step HW Monthly Forecasts of Crashes (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r rename-noncovid-ms-HW-monthly-fcast, echo=FALSE, include=FALSE}
fcast.ms.HW.monthly.noncovid <- 
  summary(forecast::forecast(crashes.train_HW_noncovid_monthly, h=14, 
                             level=c(80,95)))

rownames(fcast.ms.HW.monthly.noncovid) <- seq(as.Date("2019/01/01"),
                                           as.Date("2020/02/29"), "month")
```

```{r noncovid-ms-HW-monthly-fcast-filter-decomp-sum, echo=FALSE, message=FALSE}
head(fcast.ms.HW.monthly.noncovid)

autoplot(training_HW_noncovid_monthly, series="Training data") +
  autolayer(fitted(crashes.train_HW_noncovid_monthly, h=12),
            series="12-step fitted values") + 
  theme(legend.position = "bottom") + 
  ggtitle("Box Decomposition") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r noncovid-ms-STLF-forecast-ts, echo=FALSE, message=FALSE}
training_STLF_noncovid_monthly <- subset(crashes_mts4.noncovid, end=length(crashes_mts4.noncovid)-14)

test_STLF_noncovid_monthly <- subset(crashes_mts4.noncovid, start=length(crashes_mts4.noncovid)-13)

crashes.train_STLF_noncovid_monthly <- stlf(training_STLF_noncovid_monthly, lambda = 0, h = 14, level=c(80,95))

crashes.train_STLF_noncovid_monthly %>%
  forecast::forecast(h=14) %>%
  autoplot() + autolayer(test_STLF_noncovid_monthly) + 
  ggtitle("Multi-Step STLF Monthly Forecasts of Crashes (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r rename-noncovid-ms-STLF-fcast, echo=FALSE, include=FALSE}
fcast.ms.STLF.monthly.noncovid <- summary(crashes.train_STLF_noncovid_monthly)

rownames(fcast.ms.STLF.monthly.noncovid) <- seq(as.Date("2019/01/01"),
                                           as.Date("2020/02/29"), "month")
```

```{r noncovid-ms-STLF-fcast-filter-decomp-sum, echo=FALSE, message=FALSE}
head(fcast.ms.STLF.monthly.noncovid)

autoplot(training_STLF_noncovid_monthly, series="Training data") +
  autolayer(fitted(crashes.train_STLF_noncovid_monthly, h=12),
            series="12-step fitted values") + 
  ggtitle("12-Step Fitted Values") + 
  xlab("Date") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

```{r ets-MAM-covid, echo=FALSE, message=FALSE}
##Working with ets() monthly covid MAM model 
fit.ets.monthly.covid <- ets(y=crashes_mts4, model="MAM")

summary(fit.ets.monthly.covid)

autoplot(fit.ets.monthly.covid) + 
  ggtitle("Components of ETS Multiplicative HoltWinters Method with Multiplicative Errors (With Pandemic Data)") + 
  theme(title = element_text(size = 7)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.covid),
      'Forecast errors' = residuals(fit.ets.monthly.covid,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative HoltWinters Method with Multiplicative Errors (With Pandemic Data)") + 
  theme(title = element_text(size=8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.covid %>% forecast(h=8) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative HoltWinters Method with Multiplicative Errors (With Pandemic Data)") + 
  theme(title = element_text(size=8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

```{r ets-MNM-covid, echo=FALSE, message=FALSE}
##Working with ets() monthly MNM covid model 

fit.ets.monthly.covid.MNM <-ets(y=crashes_mts4, model="ZZM")
#automatically selects MNM

summary(fit.ets.monthly.covid.MNM)
#alpha = 0.3386, gamma = 2e-04

autoplot(fit.ets.monthly.covid.MNM) + 
  ggtitle("Components of ETS Multiplicative Seasonality and Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size = 9)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.covid.MNM),
      'Forecast errors' = residuals(fit.ets.monthly.covid.MNM,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative Seasonality and Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size=10)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.covid.MNM %>% forecast(h=8) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative Seasonality and Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size=10)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

```{r ets-MMM-covid, echo=FALSE, message=FALSE}
##Working with ets() monthly MMM covid model 

fit.ets.monthly.covid.MMM <-ets(y=crashes_mts4, model="MMM")

summary(fit.ets.monthly.covid.MMM)

autoplot(fit.ets.monthly.covid.MMM) + 
  ggtitle("Components of ETS Multiplicative Seasonality, Trend, and Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size = 8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.covid.MMM),
      'Forecast errors' = residuals(fit.ets.monthly.covid.MMM,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative Seasonality, Trend, and Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size=9)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.covid.MMM %>% forecast(h=8) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative Seasonality, Trend, and Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size=9)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

```{r ets-MNA-covid, echo=FALSE, message=FALSE}
##Working with ets() monthly MNA covid model 

fit.ets.monthly.covid.MNA <-ets(y=crashes_mts4, model="MNA")
summary(fit.ets.monthly.covid.MNA)

autoplot(fit.ets.monthly.covid.MNA) + 
  ggtitle("Components of ETS Multiplicative Seasonality and Additive Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size = 8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.covid.MNA),
      'Forecast errors' = residuals(fit.ets.monthly.covid.MNA,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative Seasonality and Additive Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size=9)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.covid.MNA %>% forecast(h=8) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative Seasonality and Additive Errors Method (With Pandemic Data)") + 
  theme(title = element_text(size=8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

```{r ets-MAM-noncovid, echo=FALSE, message=FALSE}
##Working with ets() monthly noncovid MAM model 
fit.ets.monthly.noncovid <- ets(y=crashes_mts4.noncovid, model="MAM")

summary(fit.ets.monthly.noncovid)

autoplot(fit.ets.monthly.noncovid) + 
  ggtitle("Components of ETS Multiplicative HoltWinters Method with Multiplicative Errors (Without Pandemic Data)") + 
  theme(title = element_text(size = 6)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.noncovid),
      'Forecast errors' = residuals(fit.ets.monthly.noncovid,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative HoltWinters Method with Multiplicative Errors (Without Pandemic Data)") + 
  theme(title = element_text(size=7)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.noncovid %>% forecast(h=23) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative HoltWinters Method with Multiplicative Errors (Without Pandemic Data)") + 
  theme(title = element_text(size=7)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

```{r ets-MNM-noncovid, echo=FALSE, message=FALSE}
##Working with ets() monthly MNM noncovid model 

fit.ets.monthly.noncovid.MNM <-ets(y=crashes_mts4.noncovid, model="MNM")

summary(fit.ets.monthly.noncovid.MNM)

autoplot(fit.ets.monthly.noncovid.MNM) + 
  ggtitle("Components of ETS Multiplicative Seasonality and Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size = 8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.noncovid.MNM),
      'Forecast errors' = residuals(fit.ets.monthly.noncovid.MNM,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative Seasonality and Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size=9)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.noncovid.MNM %>% forecast(h=23) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative Seasonality and Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size=9)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

```{r ets-MMM-noncovid, echo=FALSE, message=FALSE}
##Working with ets() monthly MMM noncovid model 

fit.ets.monthly.noncovid.MMM <-ets(y=crashes_mts4.noncovid, model="MMM")

summary(fit.ets.monthly.noncovid.MMM)

autoplot(fit.ets.monthly.noncovid.MMM) + 
  ggtitle("Components of ETS Multiplicative Seasonality, Trend, and Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size = 7)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.noncovid.MMM),
      'Forecast errors' = residuals(fit.ets.monthly.noncovid.MMM,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative Seasonality, Trend, and Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size=8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.noncovid.MMM %>% forecast(h=23) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative Seasonality, Trend, and Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size=8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

```{r ets-MNA-noncovid, echo=FALSE, message=FALSE}
##Working with ets() monthly MNA noncovid model 

fit.ets.monthly.noncovid.MNA <-ets(y=crashes_mts4.noncovid, model="MNA")
summary(fit.ets.monthly.noncovid.MNA)

autoplot(fit.ets.monthly.noncovid.MNA) + 
  ggtitle("Components of ETS Multiplicative Seasonality and Additive Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size = 7)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) +
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")

cbind('Residuals' = residuals(fit.ets.monthly.noncovid.MNA),
      'Forecast errors' = residuals(fit.ets.monthly.noncovid.MNA,type='response')) %>%
  autoplot(facet=TRUE) + xlab("Year") + ylab("") + 
  ggtitle("Residuals of ETS Multiplicative Seasonality and Additive Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size=8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90))

fit.ets.monthly.noncovid.MNA %>% forecast(h=23) %>%
  autoplot() + 
  ggtitle("Forecasts from ETS Multiplicative Seasonality and Additive Errors Method (Without Pandemic Data)") + 
  theme(title = element_text(size=8)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Date") + ylab("Crashes")
```

### Forecasting with Covariates 

```{r snow-dummy, echo=FALSE, message=FALSE}
##Adding dummy variables to dataset 
#snow
crashes_snow = crashes %>%
  mutate(Snow = case_when(
    WeatherCondition1 == "Snow" ~ 1, 
    TRUE ~ 0)) 

crashes_snow = crashes_snow %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2021/05/31") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date,Snow) %>% #am I grouping by the right things? 
  summarize(count = length(unique(key_crash)))

#Converting crashes_snow to a time series object 
crashes_snow_ts2 <- ts(crashes_snow$count, start = c(2015,1), end = c(2021,153),
                       frequency = 365)

#Converting crashes_snow to a time series object (not the method to use)
crashes_snow_ts <- as.ts(crashes_snow)
```

```{r snow-forecast-attempt, echo=FALSE, message=FALSE, eval=FALSE}
##attempting blogpost code (works)
y <- ts(crashes_snow$count, frequency=7)
z <- fourier(ts(crashes_snow$count, frequency=365.25), K=5)
zf <- fourier(ts(crashes_snow$count, frequency=365.25), K=5, h=100)
fit <- auto.arima(y, xreg=cbind(z), seasonal=FALSE)
fc <- forecast(fit, xreg=cbind(zf), h=100)

autoplot(fc)
```

```{r snow-forecast, echo=FALSE, message=FALSE}
##attempting textbook (Works)
#crashes_snow_ts3 <- window(crashes_snow)
crashes_snow_ts2 <- ts(crashes_snow$count, start = c(2015,1), end = c(2021,153),
                       frequency = 365)
plots_snow <- list()
for (i in seq(6)) {
  fit <- auto.arima(crashes_snow_ts2, xreg = fourier(crashes_snow_ts2, K = i),
                    seasonal = FALSE, lambda = 0)
  plots_snow[[i]] <- autoplot(forecast(fit,
                                  xreg=fourier(crashes_snow_ts2, K=i, h=214))) +
    xlab(paste("K=",i,"   AICC=",round(fit[["aicc"]],2))) +
    ylab("") + 
    theme(title = element_text(size = 8))
}

#loading necessary packages
#install.packages("gridExtra")
library(gridExtra)

gridExtra::grid.arrange(
  plots_snow[[1]],plots_snow[[2]],plots_snow[[3]],
  plots_snow[[4]],plots_snow[[5]],plots_snow[[6]], nrow=3)
```

```{r snow-best-forecast, echo=FALSE, message=FALSE}
plots_snow[[4]]
```

```{r snow-forecast-attempt2, echo=FALSE, message=FALSE, eval=FALSE}
#diff attempt (TAKES A LONG TIME (because K=1-25) BUT IT DOES WORK)
bestfit <- list(aicc=Inf)
for(K in seq(25)) {
  fit <- auto.arima(crashes_snow_ts2, xreg=fourier(crashes_snow_ts2, K=K),
                    seasonal=FALSE)
  if(fit[["aicc"]] < bestfit[["aicc"]]) {
    bestfit <- fit
    bestK <- K
  }
}

fc <- forecast(bestfit,
               xreg=fourier(crashes_snow_ts2, K=bestK, h=214))
autoplot(fc)
```

```{r friday-dummy, echo=FALSE, message=FALSE}
##friday dummy variable
crashes_friday = crashes %>%
  mutate(Friday = case_when(
    Crash_Date_DOW == "Friday" ~ 1, 
    TRUE ~ 0)) 

crashes_friday = crashes_friday %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2021/05/31") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date,Friday) %>% #am I grouping by the right things? 
  summarize(count = length(unique(key_crash)))

#Converting crashes_ts to a time series object 
crashes_friday_ts2 <- ts(crashes_friday$count, start = c(2015,1), end = c(2021,153),
                         frequency = 365)

#Converting crashes_ts to a time series object 
crashes_friday_ts <- as.ts(crashes_friday)
```

```{r friday-forecast-attempt, echo=FALSE, message=FALSE, eval=FALSE}
##attempting blogpost 
y <- ts(crashes_friday$count, frequency=7)
z <- fourier(ts(crashes_friday$count, frequency=365.25), K=5)
zf <- fourier(ts(crashes_friday$count, frequency=365.25), K=5, h=100)
fit <- auto.arima(y, xreg=cbind(z), seasonal=FALSE)
fc <- forecast(fit, xreg=cbind(zf), h=100)
autoplot(fc)
```

```{r friday-forecast, echo=FALSE, message=FALSE}
##attempting textbook 
#crashes_friday_ts3 <- window(crashes_friday)
crashes_friday_ts2 <- ts(crashes_friday$count, start = c(2015,1), end = c(2021,153),
                         frequency = 365)
plots_friday <- list()
for (i in seq(6)) {
  fit <- auto.arima(crashes_friday_ts2, xreg = fourier(crashes_friday_ts2, K = i),
                    seasonal = FALSE, lambda = 0)
  plots_friday[[i]] <- autoplot(forecast(fit,
                                  xreg=fourier(crashes_friday_ts2, K=i, h=214))) +
    xlab(paste("K=",i,"   AICC=",round(fit[["aicc"]],2))) +
    ylab("") + 
    theme(title = element_text(size = 8))
}

#loading necessary packages
#install.packages("gridExtra")
#library(gridExtra)

gridExtra::grid.arrange(
  plots_friday[[1]],plots_friday[[2]],plots_friday[[3]],
  plots_friday[[4]],plots_friday[[5]],plots_friday[[6]], nrow=3)
```

```{r friday-best-forecast, echo=FALSE, message=FALSE}
plots_friday[[1]]
```

```{r friday-forecast-attempt2, echo=FALSE, message=FALSE, eval=FALSE}
#diff attempt (TAKES A LONG TIME BUT WORKS)
bestfit <- list(aicc=Inf)
for(K in seq(25)) {
  fit <- auto.arima(crashes_friday_ts2, xreg=fourier(crashes_friday_ts2, K=K),
                    seasonal=FALSE)
  if(fit[["aicc"]] < bestfit[["aicc"]]) {
    bestfit <- fit
    bestK <- K
  }
}

fc <- forecast(bestfit,
               xreg=fourier(crashes_friday_ts2, K=bestK, h=214))
autoplot(fc)
```

```{r snow-friday-dummy, echo=FALSE, message=FALSE}
##friday and snow together 
crashes_snow_friday = crashes %>%
  mutate(Friday = case_when(
    Crash_Date_DOW == "Friday" ~ 1, 
    TRUE ~ 0)) %>%
  mutate(Snow = case_when(
    WeatherCondition1 == "Snow" ~ 1, 
    TRUE ~ 0))

crashes_snow_friday = crashes_snow_friday %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2021/05/31") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date,Friday,Snow) %>% #am I grouping by the right things? 
  summarize(count = length(unique(key_crash)))

#Converting crashes_ts to a time series object 
crashes_snow_friday_ts2 <- ts(crashes_snow_friday$count, start = c(2015,1), end = c(2021,153),
                              frequency = 365)

#Converting crashes_ts to a time series object 
crashes_snow_friday_ts <- as.ts(crashes_snow_friday)
```

```{r snow-friday-forecast-attempt, echo=FALSE, message=FALSE, eval=FALSE}
##attempting blogpost 
y <- ts(crashes_snow_friday$count, frequency=7)
z <- fourier(ts(crashes_snow_friday$count, frequency=365.25), K=5)
zf <- fourier(ts(crashes_snow_friday$count, frequency=365.25), K=5, h=100)
fit <- auto.arima(y, xreg=cbind(z), seasonal=FALSE)
fc <- forecast(fit, xreg=cbind(zf), h=100)
autoplot(fc)
```

```{r snow-friday-forecast, echo=FALSE, message=FALSE}
##attempting textbook 
#crashes_friday_ts3 <- window(crashes_friday)
crashes_snow_friday_ts2 <- ts(crashes_snow_friday$count, start = c(2015,1), end = c(2021,153),
                              frequency = 365)
plots_snow_friday <- list()
for (i in seq(6)) {
  fit <- auto.arima(crashes_snow_friday_ts2, xreg = fourier(crashes_snow_friday_ts2, K = i),
                    seasonal = FALSE, lambda = 0)
  plots_snow_friday[[i]] <- autoplot(forecast(fit,
                                  xreg=fourier(crashes_snow_friday_ts2, K=i, h=214))) +
    xlab(paste("K=",i,"   AICC=",round(fit[["aicc"]],2))) +
    ylab("") + 
    theme(title = element_text(size = 8))
}

#loading necessary packages
#install.packages("gridExtra")
#library(gridExtra)

gridExtra::grid.arrange(
  plots_snow_friday[[1]],plots_snow_friday[[2]],plots_snow_friday[[3]],
  plots_snow_friday[[4]],plots_snow_friday[[5]],plots_snow_friday[[6]], nrow=3)
```

```{r snow-friday-best-forecast, echo=FALSE, message=FALSE}
plots_snow_friday[[1]]
```

```{r snow-friday-forecast-attempt2, echo=FALSE, message=FALSE, eval=FALSE}
#diff attempt (TAKES A LONG TIME BUT WORKS)
bestfit <- list(aicc=Inf)
for(K in seq(25)) {
  fit <- auto.arima(crashes_snow_friday_ts2, xreg=fourier(crashes_snow_friday_ts2, K=K),
                    seasonal=FALSE)
  if(fit[["aicc"]] < bestfit[["aicc"]]) {
    bestfit <- fit
    bestK <- K
  }
}

fc <- forecast(bestfit,
               xreg=fourier(crashes_snow_friday_ts2, K=bestK, h=214))
autoplot(fc)
```

### Advanced Forecasting Methods 

```{r nnetar-fit-sum, echo=FALSE}
fit.nnetar <- nnetar(crashests2, lambda=0)

summary(fit.nnetar)
```

```{r rename-nnetar-fcast, echo=FALSE, include=FALSE}
fcast.nnetar.summary <- summary(forecast::forecast(fit.nnetar, h=214))

rownames(fcast.nnetar.summary) <- seq(as.Date("2021/06/01"), 
                                                     as.Date("2021/12/31"), "day")
```

```{r nnetar-fcast-filter-forecast-ts, echo=FALSE}
head(fcast.nnetar.summary)

autoplot(forecast(fit.nnetar,h=212,lambda=0)) + 
  ggtitle("NNAR Forecasting Model of Daily Crashes (With Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r noncovid-nnetar-fit-sum, echo=FALSE}
fit.nnetar.noncovid <- nnetar(crashests.noncovid, lambda=0)

summary(fit.nnetar.noncovid)
```

```{r rename-noncovid-nnetar-fcast, echo=FALSE, include=FALSE}
fcast.nnetar.noncovid.summary <- summary(forecast::forecast(fit.nnetar.noncovid, h=671))

rownames(fcast.nnetar.noncovid.summary) <- seq(as.Date("2020/03/01"), 
                                                     as.Date("2021/12/31"), "day")
```

```{r noncovid-nnetar-fcast-filter-forecast-ts, echo=FALSE}
head(fcast.nnetar.noncovid.summary)

autoplot(forecast(fit.nnetar.noncovid,h=672,lambda=0)) + 
  ggtitle("NNAR Forecasting Model of Daily Crashes (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r nnetar-monthly-fit-sum-forecast-ts, echo=FALSE, message=FALSE}
fit.nnetar.monthly <- nnetar(crashes_mts4, lambda=0)

summary(fit.nnetar.monthly)

forecast::forecast(fit.nnetar.monthly, h=6)

autoplot(forecast(fit.nnetar.monthly,h=20,lambda=0)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7, 8, 9), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022", 
                                "Jan 2023")) + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("NNAR Forecasting Model of Monthly Crashes (Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r noncovid-nnetar-monthly-fit-sum-forecast-ts, echo=FALSE, message=FALSE}
fit.nnetar.monthly.noncovid <- nnetar(crashes_mts4.noncovid, lambda=0)

summary(fit.nnetar.monthly.noncovid)

forecast::forecast(fit.nnetar.monthly.noncovid, h=25)

autoplot(forecast(fit.nnetar.monthly.noncovid,h=25,lambda=0)) + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7, 8), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021", "Jan 2022")) + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("NNAR Forecasting Model of Monthly Crashes (Without Pandemic Data)") + 
  xlab("Date") + ylab("Crashes")
```

```{r 2015-2019-ts, echo=FALSE, include=FALSE}
crashes_ts.2019 = crashes %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2019/12/31") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date) %>%
  summarize(count = length(unique(key_crash)))

crashes_ts.2019 %>%
  filter(as.Date(Date) >= "2015/01/01") %>%
  ggplot(aes(x = as.Date(Date), y = count)) + 
  geom_line() + 
  scale_x_date(date_labels = "%m-%Y", date_breaks = "6 month") + 
  theme(axis.text.x = element_text(angle = 90)) + 
  ggtitle("2015-2019 Time Series") + 
  xlab("Date") + ylab("Crashes")
```

```{r regression-2015-2019-ts, echo=FALSE, message=FALSE, include=FALSE}
#Converting crashes_ts.2019 to a time series object 
crashests.2019 <- ts(crashes_ts.2019$count, start = c(2015,1), end = c(2019,365),
                         frequency = 365)

#Converting crashes_ts to a time series object 
crashests.2019.2 <- as.ts(crashes_ts.2019, start = c(2015,1), end = c(2019,365), 
                             frequency = 365)

#Least squares estimation
fit.crashes.2019.2 <- tslm(count ~ Date, data=crashests.2019.2)
summary(fit.crashes.2019.2)

#Fitted values (linear plot through ts)
autoplot(crashests.2019.2[,'count'], series="Data") +
  autolayer(fitted(fit.crashes.2019.2), series="Fitted") +
  xlab("Date") + ylab("") +
  ggtitle("2015-2019 Number of Daily Car Crashes") +
  guides(colour=guide_legend(title=" ")) + 
  scale_x_continuous(breaks = c(0, 181, 365, 547, 731, 912, 1096, 1277, 
                                1461, 1642, 1826), 
                     labels = c("01-2015", "07-2015", "01-2016", "07-2016", 
                                "01-2017", "07-2017", "01-2018", "07-2018", 
                                "01-2019", "07-2019", "01-2020")) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r 2015-2019-HW-fcast-decomp, echo=FALSE, include=FALSE}
twentynineteen <- HoltWinters(crashests.2019)

summary(twentynineteen)

plot(fitted(twentynineteen), main = "Box Jenkins Decomposition of Daily Crashes") 

fcast.2019 <- forecast::forecast(twentynineteen, h=61, level=c(80,95))
```

```{r rename-2015-2019-HW-fcast-true-val-crash, echo=FALSE, include=FALSE}
twenty_nineteen_daily_forecast_values_HW <- summary(fcast.2019)

rownames(twenty_nineteen_daily_forecast_values_HW) <- seq(as.Date("2020/01/01"),
                                                          as.Date("2020/03/01"),
                                                          "day")
true_value = crashes_ts %>%
  filter(Date >= as.Date("2020/01/01") & Date <= as.Date("2020/03/01"))

twenty_nineteen_daily_forecast_values_HW <- twenty_nineteen_daily_forecast_values_HW %>%
  mutate(true_count = true_value$count)
```

```{r 2015-2019-HW-fcast-filter-forecast-ts, echo=FALSE, include=FALSE}
twenty_nineteen_daily_forecast_values_HW

autoplot(fcast.2019) +
  ggtitle("2015-2019 Forecasts of Daily Car Crashes Using HoltWinters") +
  xlab("Year") + ylab("Crashes") 
```

```{r 2015-2019-STLF-fit-forecast-ts, echo=FALSE, include=FALSE}
crashests.2019 %>% mstl() %>%
  autoplot() + 
  ggtitle("Box Jenkins Decomposition") + 
  xlab("Date") + ylab("Count")

p <- crashests.2019 %>%
  stlf(lambda = 0, h = 61, level=c(80,95)) 

p %>%
  autoplot() + 
  ggtitle("2015-2019 STLF Model for Daily Car Crashes") +
  xlab("Date") + ylab("Daily Crashes")
```

```{r rename-2015-2019-STLF-fcast-true-val-crash, echo=FALSE, include=FALSE}
twenty_nineteen_daily_forecast_values_STLF <- summary(p)

rownames(twenty_nineteen_daily_forecast_values_STLF) <- seq(as.Date("2020/01/01"), as.Date("2020/03/01"), "day")

true_value = crashes_ts %>%
  filter(Date >= as.Date("2020/01/01") & Date <= as.Date("2020/03/01"))

twenty_nineteen_daily_forecast_values_STLF <- twenty_nineteen_daily_forecast_values_STLF %>%
  mutate(true_count = true_value$count)
```

```{r 2015-2019-fcast-filter, echo=FALSE, include=FALSE}
twenty_nineteen_daily_forecast_values_STLF
```

```{r 2015-2019-monthly-ts, echo=FALSE, message=FALSE, include=FALSE}
crashes_mts.2019 = crashes %>%
  filter(as.Date(crash_date) >= "2015/01/01" & as.Date(crash_date) <= "2019/12/31") %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date) %>%
  summarize(count = length(unique(key_crash))) %>%
  separate(Date, into = c("Year", "Month", "Day"), sep = "/") %>%
  group_by(Year, Month) %>%
  summarise(mcount = sum(count)) %>%
  tidyr::spread(key=Month, value=mcount)

crashes_mts.2019 = as.data.frame(crashes_mts.2019)

rownames(crashes_mts.2019) = seq(2015, 2019)

crashes_mts3.2019 = crashes_mts.2019 %>%
  select(02:13)

crashes_mts2.2019 <- ts(c(t(crashes_mts3.2019)), frequency=12)

crashes_mts4.2019 <- window(crashes_mts2.2019, start=c(1,01), end=c(5,12), 
                            frequency=12)
```

```{r 2015-2019-lin-monthly-forecast-ts, echo=FALSE, message=FALSE, include=FALSE}
fit.crashes.2019 <- tslm(crashes_mts4.2019 ~ trend + season)

summary(fit.crashes.2019)

fcast.2019 <- forecast::forecast(fit.crashes.2019, h=3, level=c(80,95))

twenty_nineteen_monthly_forecast_values_lin <- summary(fcast.2019)

rownames(twenty_nineteen_monthly_forecast_values_lin) <- seq(as.Date("2020/01/01"), as.Date("2020/03/01"), "month")

twenty_nineteen_monthly_forecast_values_lin

autoplot(fcast.2019) +
  ggtitle("2015-2019 Forecasts of Monthly Car Crashes Using Linear Model") +
  xlab("Year") + ylab("Monthly Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90))
  
```

```{r 2015-2019-HW-fit-fcast-true-forecast-ts, echo=FALSE, message=FALSE, include=FALSE}
covid.monthly.2019 <- HoltWinters(crashes_mts4.2019)

summary(covid.monthly.2019)

plot(fitted(covid.monthly.2019), main = "2015-2019 Box Jenkins Decomposition of Monthly Crashes") 

fcast.covid.monthly.2019 <- forecast::forecast(covid.monthly.2019, h=3,
                                               level=c(80,95))

twenty_nineteen_monthly_forecast_values_HW <- summary(fcast.covid.monthly.2019)

rownames(twenty_nineteen_monthly_forecast_values_HW) <- seq(as.Date("2020/01/01"), 
                                                           as.Date("2020/03/01"), "month")

twenty_nineteen_monthly_forecast_values_HW

autoplot(fcast.covid.monthly.2019) +
  ggtitle("Forecasts of Monthly Car Crashes Using HoltWinters") +
  xlab("Year") + ylab("Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r 2015-2019-STLF-monthly-fit-fcast-forecast-ts, echo=FALSE, message=FALSE, include=FALSE}
crashes_mts4.2019 %>% mstl() %>%
  autoplot() + 
  ggtitle("Box Jenkins Decomposition") + 
  xlab("Date") +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90))

t <- crashes_mts4.2019 %>%
  stlf(lambda = 0, h = 3, level=c(80,95)) 

t %>%
  autoplot() + 
  ggtitle("2015-2019 Seasonal and Trend Decomposition Using Loess Forecasting Model for Monthly Car Crashes") +
  xlab("Year") + ylab("Daily Crashes") + 
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Jan 2015", "Jan 2016", "Jan 2017", "Jan 2018", 
                                "Jan 2019", "Jan 2020", "Jan 2021")) + 
  theme(axis.text.x = element_text(angle = 90))

twenty_nineteen_monthly_forecast_values_STLF <- summary(t)

rownames(twenty_nineteen_monthly_forecast_values_STLF) <- seq(as.Date("2020/01/01"), as.Date("2020/03/01"), "month")

twenty_nineteen_monthly_forecast_values_STLF

```

## Statistical Analyses 

### ANOVA 

```{r crashes-dow, echo=FALSE, message=FALSE}
crashes_dow = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  group_by(Date, Crash_Date_DOW) %>%
  summarize(count = length(unique(key_crash)))

anova_dow = aov(count ~ Crash_Date_DOW, data = crashes_dow)
summary(anova_dow)

TukeyHSD(anova_dow)
```

```{r crashes-race, echo=FALSE, message=FALSE}
crashes_race = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(Race != "Unknown", Race != "NA") %>%
  group_by(Date, Race) %>%
  summarize(count = length(key_crash))

anova_race = aov(count ~ Race, data = crashes_race)
summary(anova_race)

TukeyHSD(anova_race)
```

```{r crashes-gender, echo=FALSE, message=FALSE}
crashes_gender= crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(Gender != "Unknown", Gender != "NA") %>%
  group_by(Date, Gender) %>%
  summarize(count = length(key_crash))

anova_gender = aov(count ~ Gender, data = crashes_gender)
summary(anova_gender)

TukeyHSD(anova_gender)
```

```{r crashes-vision, echo=FALSE, message=FALSE}
crashes_vision= crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(VisionObstruction != "Unknown", VisionObstruction != "NA") %>%
  group_by(Date, VisionObstruction) %>%
  summarize(count = length(key_crash))

anova_vision = aov(count ~ VisionObstruction, data = crashes_vision)
summary(anova_vision)

TukeyHSD(anova_vision)
```

```{r crashes-vehicle, echo=FALSE, message=FALSE}
crashes_vehicle= crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(VehicleType != "Unknown", VehicleType != "NA", VehicleType != "") %>%
  group_by(Date, VehicleType) %>%
  summarize(count = length(key_crash))

anova_vehicle = aov(count ~ VehicleType, data = crashes_vehicle)
summary(anova_vehicle)

TukeyHSD(anova_vehicle)
```

```{r crashes-weather, echo=FALSE, message=FALSE}
crashes_weather= crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(WeatherCondition1 != "Unknown", WeatherCondition1 != "NA") %>%
  group_by(Date, WeatherCondition1) %>%
  summarize(count = length(key_crash))

anova_weather = aov(count ~ WeatherCondition1, data = crashes_weather)
summary(anova_weather)

TukeyHSD(anova_weather)
```

```{r crashes-traffic, echo=FALSE, message=FALSE}
crashes_traffic= crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(TrafficControlType != "Unknown", TrafficControlType != "NA") %>%
  group_by(Date, TrafficControlType) %>%
  summarize(count = length(key_crash))

anova_traffic = aov(count ~ TrafficControlType, data = crashes_traffic)
summary(anova_traffic)

TukeyHSD(anova_traffic)
```

```{r crashes-roadfeat, echo=FALSE, message=FALSE}
crashes_roadfeat = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(RoadFeature != "Unknown", RoadFeature != "NA", RoadFeature != "NaN") %>%
  group_by(Date, RoadFeature) %>%
  summarize(count = length(key_crash))

anova_roadfeat = aov(count ~ RoadFeature, data = crashes_roadfeat)
summary(anova_roadfeat)

TukeyHSD(anova_roadfeat)
```

```{r crashes-alcohol, echo=FALSE, message=FALSE}
crashes_alcohol= crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(AlcoholResultType != "Unknown", AlcoholResultType != "NA") %>%
  group_by(Date, AlcoholResultType) %>%
  summarize(count = length(key_crash))

anova_alcohol = aov(count ~ AlcoholResultType, data = crashes_alcohol)
summary(anova_alcohol)

TukeyHSD(anova_alcohol)
```

```{r crashes-month, echo=FALSE, message=FALSE}
crashes_month = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(Crash_Date_Month != "Unknown", Crash_Date_Month != "NA") %>%
  group_by(Date, Crash_Date_Month) %>%
  summarize(count = length(key_crash))

anova_month = aov(count ~ Crash_Date_Month, data = crashes_month)
summary(anova_month)

TukeyHSD(anova_month)
```

```{r crashes-airbag, echo=FALSE, message=FALSE}
crashes_airbag = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(AirbagDeployed != "Unknown", AirbagDeployed != "NA") %>%
  group_by(Date, AirbagDeployed) %>%
  summarize(count = length(key_crash))

anova_airbag = aov(count ~ AirbagDeployed, data = crashes_airbag)
summary(anova_airbag)

TukeyHSD(anova_airbag)
```

```{r crashes-protect, echo=FALSE, message=FALSE}
crashes_protection = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(Protection != "Unknown", Protection != "NA", 
         Protection != "Unable to determine") %>%
  group_by(Date, Protection) %>%
  summarize(count = length(key_crash))

anova_protection = aov(count ~ Protection, data = crashes_protection)
summary(anova_protection)

TukeyHSD(anova_protection)
```

```{r crashes-contrib, echo=FALSE, message=FALSE}
crashes_contributing = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(ContributingCircumstance1 != "Unknown", 
         ContributingCircumstance1 != "NA") %>%
  group_by(Date, ContributingCircumstance1) %>%
  summarize(count = length(key_crash))

anova_contributing = aov(count ~ ContributingCircumstance1, 
                         data = crashes_contributing)
summary(anova_contributing)

TukeyHSD(anova_contributing)
```

```{r crashes-firstharm, echo=FALSE, message=FALSE}
crashes_first_harm = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(FirstHarmfulEvent != "Unknown", FirstHarmfulEvent != "NA") %>%
  group_by(Date, FirstHarmfulEvent) %>%
  summarize(count = length(key_crash))

anova_first_harm = aov(count ~ FirstHarmfulEvent, data = crashes_first_harm)
summary(anova_first_harm)

TukeyHSD(anova_first_harm)
```

```{r crashes-mostharm, echo=FALSE, message=FALSE}
crashes_most_harm = crashes %>%
  separate(crash_date, 
           into = c("Date", "Hour"), sep = 11) %>%
  filter(MostHarmfulEvent != "Unknown", MostHarmfulEvent != "NA") %>%
  group_by(Date, MostHarmfulEvent) %>%
  summarize(count = length(key_crash))

anova_most_harm = aov(count ~ MostHarmfulEvent, data = crashes_most_harm)
summary(anova_most_harm)

TukeyHSD(anova_most_harm)
```

### t Test

```{r crashes-rain, echo=FALSE, message=FALSE}
crashes_rain = crashes %>%
  filter(WeatherCondition1 != "Unknown", WeatherCondition1 != "NA", 
         WeatherCondition1 != "") %>%
  mutate(WeatherCondition1 = case_when(
    WeatherCondition1 == "Rain" ~ "Rain", 
    TRUE ~ "Not Rain")) %>%
  group_by(key_crash,WeatherCondition1) %>%
  summarize(count = length(key_crash))

crashes_rain <- mutate(crashes_rain, rain = WeatherCondition1 == "Rain")

t.test(count ~ rain, data = crashes_rain)

crashes_rain %>%
  ggplot(aes(fill=WeatherCondition1, x=WeatherCondition1)) + 
  geom_bar(show.legend = FALSE) + 
  geom_text(stat="count", aes(x=WeatherCondition1, label=..count..), vjust=-0.25)
```

